using FastMultipole
using FastMultipole.StaticArrays

local_expansion_real = [0.0007304189061878632, 2.6181309188492824e-5, -2.8305341814115658e-5, -9.851913916645185e-8, -3.044302307728944e-6, 6.56906411760827e-7, -4.356416218985083e-7, -2.067796993022506e-7, 1.1781894495195469e-7, 8.942250562413789e-7, -1.0578550455997353e-7, 4.535190649531797e-8, 1.6458925770122264e-8, 2.244551573858388e-7, -5.478467021606633e-7, -6.2913318945079945e-9, 2.702427686594662e-8, -3.3809934558380917e-10, 4.7435435422873546e-8, -1.7684328726345957e-7, 2.2999623560255234e-7, 8.086822467752775e-9, 6.308870410126245e-9, -1.5155917275592239e-9, 4.361317588145358e-9, -5.006517178984576e-8, 9.076219134682003e-8, -4.9368084227121736e-8, 4.674776517514757e-9, -8.405260378249454e-10, -6.634978581549077e-10, -3.0861314263505452e-9, -9.203747681309503e-9, 3.221235152351785e-8, -2.303496231272998e-8, -3.937122950587686e-8, 9.295849888752624e-10, -1.6631901518578334e-9, -8.40847950805411e-11, -2.357486043857186e-9, 1.6557673844280129e-9, 8.62067156791257e-9, -9.832586388445787e-9, -2.1184329433707807e-8, 7.19981245931732e-8, -6.303263373777468e-10, -8.020124108741314e-10, 1.0809835106937436e-10, -7.581326633730433e-10, 2.776933181799831e-9, 2.3045098263261734e-10, -3.4168832737155904e-9, -1.0556398439173249e-8, 4.3924219292820935e-8, -6.783950403495566e-8, -7.308127821406477e-10, -1.3886479326117036e-11, 9.961273990486287e-11, 1.6271842354122622e-10, 1.4615626123744942e-9, -1.7753092888890378e-9, -5.57857272241504e-10, -4.4825015564394855e-9, 2.5049735331469818e-8, -4.626967907319691e-8, 3.699704757780915e-8, -2.979634622559637e-10, 3.0746192642907966e-10, 3.347032627837514e-11, 3.987277360143979e-10, 1.6687563682533175e-10, -1.4065797489197321e-9, 4.5570013924976703e-10, -1.2218876937758198e-9, 1.2545581483241868e-8, -2.9716351712723657e-8, 2.7901774078466765e-8, 1.318086855052863e-8, 1.084394934554995e-10, 2.602774122191369e-10, -1.9093306883687832e-11, 2.5588345995563345e-10, -4.770239973742144e-10, -4.777964248910773e-10, 5.661914262428799e-10, 2.840298657029061e-10, 4.635189145807771e-9, -1.7118056411509903e-8, 1.993118852733293e-8, 1.0871717416674428e-8, -7.21849911064251e-8, 2.6915153636496817e-10, 5.717449049157802e-11, -3.5913321593637126e-11, 1.3747880676791511e-11, -5.133224228201413e-10, 2.4228272028500227e-10, 3.106580951675605e-10, 7.195563293190172e-10, 1.3670116671791943e-10, -7.85749639853331e-9, 1.2970246015072942e-8, 8.533923262554474e-9, -6.479543257569143e-8, 1.1976418650544343e-7, 1.8715722022735956e-10, -1.1992475287305681e-10, -2.2153761333826952e-11, -1.507841878023044e-10, -2.0455294721304208e-10, 5.105000349222778e-10, -1.0159021445178366e-12, 5.602518977109357e-10, -1.8183239066442701e-9, -1.5752102791964434e-9, 7.058601988487317e-9, 6.17435798001868e-9, -5.557885402570182e-8, 1.1614522087242501e-7, -1.1894798745330831e-7, -1.6896859442337247e-11, -1.6944320115875038e-10, 4.616251654344601e-12, -1.6713020646534426e-10, 1.5775125867040454e-10, 3.649346709396255e-10, -2.00494375421345e-10, 1.5877329065460433e-10, -1.9643793571780513e-9, 1.9844911265716196e-9, 2.354005074047126e-9, 3.858481183458852e-9, -4.4356045257515805e-8, 1.0800200208583783e-7, -1.2394806721804608e-7, 1.299484624848321e-8, -1.8772136805045751e-10, -8.062492326789928e-11, 2.4786638310338178e-11, -5.5172122974233595e-11, 3.4691261091239437e-10, -3.78881592263637e-12, -2.2228682942398726e-10, -2.188409390035308e-10, -1.0106461977040376e-9, 3.1179789487907617e-9, -9.213280097183242e-10, 1.7174690096610098e-9, -3.1306750629416945e-8, 9.414496906372064e-8, -1.2421059339818813e-7, 1.4551249983351641e-8, 2.6018043560948127e-7, -2.0482387619154198e-10, 7.79810484311902e-11, 2.4678011775088727e-11, 1.0035262602803829e-10, 2.587001846735885e-10, -3.4283260527099964e-10, -8.614780539488752e-11, -3.908550422109783e-10, 3.168411061643351e-10, 2.2989001233021225e-9, -2.5661174244508073e-9, -5.4592369545941026e-11, -1.715417887493565e-8, 7.385707717244996e-8, -1.1740445311903574e-7, 1.5712714843853875e-8, 3.08415482057474e-7, -7.050235335822092e-7, -3.931628775702426e-11, 1.9112183666569204e-10, 2.61625980322145e-12, 1.8798808704663244e-10, -5.543304370451354e-11, -4.2645767354704777e-10, 1.1768822921634636e-10, -2.7989035953714194e-10, 1.3107494761277324e-9, 2.8370347886953114e-10, -2.525201681203823e-9, -1.2248400298840738e-9, -3.3313892335531747e-9, 4.746725718528606e-8, -1.012251204199946e-7, 1.609065494747314e-8, 3.532662197243594e-7, -8.867819696463454e-7, 1.1023082401849713e-6, 2.14358311697254e-10, 1.5248185377096596e-10, -2.8258986048140222e-11, 1.225286123946798e-10, -3.935852826840786e-10, -1.543490849699804e-10, 2.5597397669573165e-10, 6.006113374931499e-11, 1.4092842932427558e-9, -1.8671219717653415e-9, -1.0448118964783077e-9, -1.5803404896456417e-9, 7.973995368103228e-9, 1.708472688458068e-8, -7.41637385955281e-8, 1.520078864715198e-8, 3.852582811147616e-7, -1.0799367374822383e-6, 1.4662919547208228e-6, -6.851052226863203e-7, 3.568891429455434e-10, -6.314061138496983e-11, -4.330127209237111e-11, -9.444130214486209e-11, -4.737883636958573e-10, 3.5980003182119995e-10, 2.04536190646106e-10, 4.347247548193874e-10, 4.080839527859852e-10, -2.9325429788579356e-9, 1.1863083745802372e-9, -1.0305196632337574e-9, 1.4066606692130156e-8, -1.269429954030663e-8, -3.676643165332268e-8, 1.25452246576372e-8, 3.906402795996641e-7, -1.2568330092605526e-6, 1.8917963057771638e-6, -9.61620712055405e-7, -2.2637395592205857e-6]

local_expansion_imag = [-1.2711890174907814e-26,-3.3336018181978886e-27,2.532506910768773e-5,-2.5255930674008087e-29,2.723635938068359e-6,-5.890063700068195e-6,2.1675720384063562e-27,1.849874075197021e-7,-1.055955875456142e-6,1.2559352221457453e-6,-9.895835532782522e-29,-4.057249295589994e-8,-1.4744105901096329e-7,3.152926794425943e-7,-1.2383147418617876e-7,1.962657040605675e-31,-2.41747257598909e-8,3.035654874317664e-9,6.66435088372178e-8,-3.9989356353999966e-8,-1.2787593896526042e-7,-7.414859674559518e-29,-5.643249154163988e-9,1.3569969210802324e-8,6.129281592892885e-9,-1.1326371246584222e-8,-5.04497224188792e-8,1.4242294157194092e-7,1.9621537748121813e-28,7.519317875681559e-10,5.93722531222611e-9,-4.336293501950528e-9,-2.0835262587963823e-9,-1.7900029917345193e-8,6.642574529774671e-8,-9.417175320927427e-8,-4.040009832273401e-31,1.4876575549543694e-9,7.513809475909669e-10,-3.3132569165879843e-9,3.744704398566358e-10,-4.78871366697996e-9,2.8341339379432966e-8,-5.0692109678792815e-8,3.435104090066112e-8,2.1489262801905598e-30,7.17311924504453e-10,-9.671569167992514e-10,-1.0657808903675044e-9,6.287927480729804e-10,-1.2749903648136345e-10,9.843508794867989e-9,-2.527178805779227e-8,2.0965805496582824e-8,1.9833884842997444e-8,5.3102534245031325e-30,1.2395264002161163e-11,-8.905265496500546e-10,2.2861059124177604e-10,3.311769149745835e-10,9.860806120208345e-10,1.6051455099333876e-9,-1.0736536396175765e-8,1.1962153444719072e-8,1.3518266779086925e-8,-5.94358033406016e-8,-1.9479919559874702e-31,-2.7498951259662674e-10,-2.988916100111724e-10,5.605383517631997e-10,3.7921873758089446e-11,7.809132013908681e-10,-1.313043288821104e-9,-2.929134455616257e-9,5.994052258427428e-9,8.675694969411144e-9,-4.480396414684835e-8,7.552704914871882e-8,-1.1247922917327891e-31,-2.32765908631713e-10,1.708017453661332e-10,3.5983168247447355e-10,-1.0807580999167144e-10,2.6507974869449724e-10,-1.6298230806303304e-9,6.793777106216124e-10,2.216213829547049e-9,4.993589960231312e-9,-3.19898444055967e-8,6.23760449964722e-8,-5.70107816583652e-8,8.557171316195476e-31,-5.111723877320346e-11,3.2081130033418376e-10,1.9402765822655258e-11,-1.1640970688922844e-10,-1.3459229768464333e-10,-8.934594880026565e-10,1.724579639576031e-9,6.62821576900096e-11,2.2897438841463192e-9,-2.0806616920815594e-8,4.902931085639412e-8,-5.119919055645648e-8,-7.3186935898288995e-9,-1.4126816400971007e-30,1.0725396291314998e-10,1.9768083803462859e-10,-2.1201499760978158e-10,-4.645598441525095e-11,-2.8330086631797124e-10,3.5020342893448586e-12,1.343913490314996e-9,-8.690968161164639e-10,4.575736791575158e-10,-1.1315996708395654e-8,3.552542071212032e-8,-4.393858074010346e-8,-7.068656550484895e-9,1.2017552731753977e-7,-3.9368971408285008e-31,1.5152020242922201e-10,-4.140248956997772e-11,-2.350862434135153e-10,3.573344079983882e-11,-2.0238489598262012e-10,5.768780925125349e-10,3.816723170739452e-10,-9.398152735344025e-10,-5.790243045550037e-10,-3.769010957278874e-9,2.2239838293320542e-8,-3.5085272257909085e-8,-6.5450515815156086e-9,1.2516183051794642e-7,-2.5567513301088416e-7,-2.2759112375895642e-29,7.208244689779369e-11,-2.2129420354193919e-10,-7.767377754733682e-11,7.872125271474667e-11,2.2270320733950467e-12,6.388814475448073e-10,-5.244420965403703e-10,-4.841567039510257e-10,-9.078606345237849e-10,1.4803948738863543e-9,9.92792471800974e-9,-2.4779101738962123e-8,-5.6790089370199376e-9,1.2535871527134243e-7,-2.8476067231105916e-7,3.2260734237987463e-7,5.704977088305597e-29,-6.974392542891602e-11,-2.2005443960266538e-10,1.4110693271097112e-10,5.878299535126843e-11,1.9021047104934319e-10,2.4702769775767473e-10,-9.38084586665077e-10,1.5103271010201166e-10,-6.681966229772157e-10,4.112508802859599e-9,-2.8887581703413283e-10,-1.3589977468331277e-8,-4.431490749412554e-9,1.1842053193450587e-7,-3.057811427537478e-7,3.8263912556997307e-7,-1.1569508289339443e-7,3.214627105727391e-30,-1.7089497589288543e-10,-2.3043739589818575e-11,2.644792976904376e-10,-1.2496738298915309e-11,2.3641673892868716e-10,-3.3873629332920724e-10,-6.72719803276423e-10,6.273151830638295e-10,-8.128973373677744e-11,4.042430041627781e-9,-7.0597247476614495e-9,-2.6505142375018935e-9,-2.8274103679669092e-9,1.0203357296122144e-7,-3.112859411523789e-7,4.385500829680497e-7,-1.4579162481680647e-7,-7.015733335360217e-7,6.620031658088454e-30,-1.363192654680337e-10,2.522358213957811e-10,1.7249966505493064e-10,-8.934435847672044e-11,8.538033921907852e-11,-7.353526030039427e-10,1.4308073176962365e-10,6.753625615287658e-10,5.437210988062917e-10,1.668353306921943e-9,-9.141334821737466e-9,6.307206505663098e-9,-9.986039428767944e-10,7.469211643446776e-8,-2.921316570721221e-7,4.785756648726575e-7,-1.7788903610676925e-7,-9.326026744254997e-7,2.4322714543409337e-6,5.988318037491601e-29,5.648818767899308e-11,3.8590966932583906e-10,-1.3273941717766732e-10,-1.0771001119523752e-10,-1.9965375640238834e-10,-5.865608135830586e-10,1.043602054130374e-9,1.965322510926927e-10,8.518961826306458e-10,-1.9035029116888268e-9,-5.989743527803963e-9,1.1145476356725204e-8,7.760071397256155e-10,3.696652943242879e-8,-2.391284929874553e-7,4.85612020107615e-7,-2.074511438302133e-7,-1.2023889952298493e-6,3.4098345651921116e-6,-4.628549724546777e-6]

local_expansion = zeros(2,4,length(local_expansion_real))
local_expansion[1,1,:] .= local_expansion_real
local_expansion[2,1,:] .= local_expansion_imag

expansion_center = SVector{3}(
    10.000000014901161,
    10.000000014901161,
    10.000000014901161
	)

target = [10.0,10,10]
derivatives_switch = FastMultipole.DerivativesSwitch(true,true,true,true)
P = 20

scalar_potential, vector_potential, velocity, gradient = FastMultipole.L2B(target, expansion_center, local_expansion, derivatives_switch, Val(P))

potential_source_check = 0.0007304189073771653
potential_source_fmm = 0.0007304189073771506
velocity_source_check = [
 2.8305341908986337e-5
 2.532506918799478e-5
 2.618130927297992e-5
]
velocity_source_fmm = [
 2.830534190899204e-5
 2.5325069187997148e-5
 2.618130927297376e-5
]
gradient_source_check = [
     -3.77713e-7  -2.94503e-6  -3.0443e-6;
 -2.94503e-6   2.79194e-7  -2.72364e-6;
 -3.0443e-6   -2.72364e-6   9.85191e-8;
]

@show velocity_source_check - velocity
@show potential_source_check - scalar_potential
@show gradient_source_check - gradient
