@testset "Legendre polynomials" begin

# Legendre polynomials
P = 10
θ = pi/7
pnms = FastMultipole.compute_Pnms(P, sin(θ), cos(θ))

for n in 0:P
    for m in 0:n
        i = FastMultipole.Pnm_index(n, m)
        @test isapprox(pnms[i], Plm(cos(θ),n,m); rtol=1e-12)
    end
end

end

#--- H matrices ---#

@testset "y axis rotations by π/2" begin

Hs_π2 = [1.0]

expansion_order = 4
FastMultipole.update_Hs_π2!(Hs_π2, Val(10))

H0 = zeros(Complex{Float64},1,1)
H0[1,1] = 1.0
H1 = [     -0.5+0.0im     0.707107+0.0im       0.5-0.0im
 0.707107+0.0im  6.12323e-17+0.0im  0.707107+0.0im
 0.5-0.0im     0.707107+0.0im      -0.5+0.0im]
H2 = [     0.25+0.0im        -0.5+0.0im    0.612372+0.0im         0.5-0.0im      0.25+0.0im
     -0.5+0.0im         0.5+0.0im  7.4994e-17+0.0im         0.5-0.0im       0.5-0.0im
 0.612372+0.0im  7.4994e-17+0.0im        -0.5+0.0im  7.4994e-17+0.0im  0.612372+0.0im
      0.5-0.0im         0.5-0.0im  7.4994e-17+0.0im         0.5+0.0im      -0.5+0.0im
      0.25+0.0im         0.5-0.0im    0.612372+0.0im        -0.5+0.0im      0.25+0.0im]
H3 = [    -0.125+0.0im     0.306186+0.0im  -0.484123+0.0im      0.559017+0.0im   0.484123-0.0im     0.306186+0.0im      0.125-0.0im
  0.306186+0.0im         -0.5+0.0im   0.395285+0.0im   8.38458e-17+0.0im   0.395285-0.0im          0.5-0.0im   0.306186+0.0im
 -0.484123+0.0im     0.395285+0.0im      0.125+0.0im     -0.433013+0.0im     -0.125-0.0im     0.395285-0.0im   0.484123-0.0im
  0.559017+0.0im  8.38458e-17+0.0im  -0.433013+0.0im  -9.18485e-17+0.0im  -0.433013+0.0im  8.38458e-17+0.0im   0.559017+0.0im
  0.484123-0.0im     0.395285-0.0im     -0.125-0.0im     -0.433013+0.0im      0.125+0.0im     0.395285+0.0im  -0.484123+0.0im
  0.306186+0.0im          0.5-0.0im   0.395285-0.0im   8.38458e-17+0.0im   0.395285+0.0im         -0.5+0.0im   0.306186+0.0im
  0.125-0.0im     0.306186+0.0im   0.484123-0.0im      0.559017+0.0im  -0.484123+0.0im     0.306186+0.0im     -0.125+0.0im]
H4 = [    0.0625+0.0im    -0.176777+0.0im   0.330719+0.0im    -0.467707+0.0im     0.522913+0.0im     0.467707-0.0im   0.330719+0.0im     0.176777-0.0im     0.0625+0.0im
 -0.176777+0.0im        0.375+0.0im  -0.467707+0.0im     0.330719+0.0im  9.05639e-17+0.0im     0.330719-0.0im   0.467707-0.0im        0.375-0.0im   0.176777-0.0im
  0.330719+0.0im    -0.467707+0.0im       0.25+0.0im     0.176777+0.0im    -0.395285+0.0im    -0.176777-0.0im       0.25-0.0im     0.467707-0.0im   0.330719+0.0im
 -0.467707+0.0im     0.330719+0.0im   0.176777+0.0im       -0.375+0.0im  -1.0269e-16+0.0im       -0.375-0.0im  -0.176777-0.0im     0.330719-0.0im   0.467707-0.0im
  0.522913+0.0im  9.05639e-17+0.0im  -0.395285+0.0im  -1.0269e-16+0.0im        0.375+0.0im  -1.0269e-16+0.0im  -0.395285+0.0im  9.05639e-17+0.0im   0.522913+0.0im
  0.467707-0.0im     0.330719-0.0im  -0.176777-0.0im       -0.375-0.0im  -1.0269e-16+0.0im       -0.375+0.0im   0.176777+0.0im     0.330719+0.0im  -0.467707+0.0im
  0.330719+0.0im     0.467707-0.0im       0.25-0.0im    -0.176777-0.0im    -0.395285+0.0im     0.176777+0.0im       0.25+0.0im    -0.467707+0.0im   0.330719+0.0im
  0.176777-0.0im        0.375-0.0im   0.467707-0.0im     0.330719-0.0im  9.05639e-17+0.0im     0.330719+0.0im  -0.467707+0.0im        0.375+0.0im  -0.176777+0.0im
  0.0625+0.0im     0.176777-0.0im   0.330719+0.0im     0.467707-0.0im     0.522913+0.0im    -0.467707+0.0im   0.330719+0.0im    -0.176777+0.0im     0.0625+0.0im]
Hs_test = [H0,H1,H2,H3,H4]


for n in 1:expansion_order
    H_test = Hs_test[n+1]
    H = FastMultipole.get_H(Hs_π2, n)
    for m in 0:n
        for mp in 0:m
            H_mp_m = H[FastMultipole.H_index(mp,m)]
            H_mp_m_test = H_test[n+mp+1,n+m+1]
            @test isapprox(H_mp_m, H_mp_m_test; atol=1e-6)
        end
    end
end

end

#--- T matrices ---#

@testset "y axis rotation matrices" begin

expansion_order = 5
β = 3*pi/7
Ts = zeros(FastMultipole.length_Ts(expansion_order))
Hs_π2 = [1.0]
FastMultipole.update_Hs_π2!(Hs_π2, Val(expansion_order))
FastMultipole.update_Ts!(Ts, Hs_π2, β, expansion_order)

T0 = ones(1,1)
T1 = [ -0.61126   0.689378   0.38874;
  0.689378  0.222521   0.689378;
  0.38874   0.689378  -0.61126;]
T2 = [  0.373639  -0.595935   0.58205    0.378993   0.151118;
 -0.595935   0.339224   0.265698   0.561745   0.378993;
  0.58205    0.265698  -0.425727   0.265698   0.58205;
  0.378993   0.561745   0.265698   0.339224  -0.595935;
  0.151118   0.378993   0.58205   -0.595935   0.373639;]
T3 = [ -0.228391    0.44614   -0.562545   0.518015   0.357758   0.180441   0.0587457;
  0.44614    -0.497851   0.15662    0.289612   0.499636   0.403118   0.180441;
 -0.562545    0.15662    0.37936   -0.31764    0.191254   0.499636   0.357758;
  0.518015    0.289612  -0.31764   -0.306236  -0.31764    0.289612   0.518015;
  0.357758    0.499636   0.191254  -0.31764    0.37936    0.15662   -0.562545;
  0.180441    0.403118   0.499636   0.289612   0.15662   -0.497851   0.44614;
  0.0587457   0.180441   0.357758   0.518015  -0.562545   0.44614   -0.228391]
T4 = [  0.139606   -0.314895    0.469804   -0.529844    0.47241    0.336961    0.190012    0.080996    0.0228368;
 -0.314895    0.481886   -0.378198    0.0422398   0.304974   0.461927    0.398295    0.228526    0.080996;
  0.469804   -0.378198   -0.0788519   0.392825   -0.245487   0.167609    0.438887    0.398295    0.190012;
 -0.529844    0.0422398   0.392825   -0.142662   -0.321788  -0.290271    0.167609    0.461927    0.336961;
  0.47241     0.304974   -0.245487   -0.321788    0.200043  -0.321788   -0.245487    0.304974    0.47241;
  0.336961    0.461927    0.167609   -0.290271   -0.321788  -0.142662    0.392825    0.0422398  -0.529844;
  0.190012    0.398295    0.438887    0.167609   -0.245487   0.392825   -0.0788519  -0.378198    0.469804;
  0.080996    0.228526    0.398295    0.461927    0.304974   0.0422398  -0.378198    0.481886   -0.314895;
  0.0228368   0.080996    0.190012    0.336961    0.47241   -0.529844    0.469804   -0.314895    0.139606;]

Ts_test = [T0,T1,T2,T3,T4]

for n in 1:length(Ts_test)-1
    T_test = Ts_test[n+1]
    T = FastMultipole.get_T(Ts, n)
    for m in 0:n
        for mp in -m:m
            T_mp_m = T[FastMultipole.T_index(mp,m)]
            T_mp_m_test = T_test[n+mp+1,n+m+1]
            @test isapprox(T_mp_m, T_mp_m_test; atol=1e-6)
        end
    end
end

end

@testset "e^{imϕ}" begin

# eimϕ
expansion_order = 10
eimϕs = zeros(2, expansion_order+1)
ϕ = π/7
FastMultipole.update_eimϕs!(eimϕs, ϕ, expansion_order)
for m in 0:expansion_order
    eimϕ_test = exp(im*m*ϕ)
    @test isapprox(real(eimϕ_test), eimϕs[1,m+1]; atol=1e-12)
    @test isapprox(imag(eimϕ_test), eimϕs[2,m+1]; atol=1e-12)
end

end

#------- MULTIPOLE ROTATIONS -------#

#--- ζ ---#

@testset "ζ normalization" begin

# test ζ_sign
expansion_order = 4
for m in 0:expansion_order
    for mp in 0:expansion_order
        r, i = FastMultipole.ζ_sign(1.0, mp, m)
        check = (1.0im)^(1.0*mp-m)
        @test isapprox(r, real(check); atol=1e-12)
        @test isapprox(i, imag(check); atol=1e-12)
    end
end

ζs_test = zeros(FastMultipole.length_ζs(expansion_order))
ζs_test[1] = 1.0
FastMultipole.update_ζs_mag!(ζs_test, 0, expansion_order)
for n in 0:expansion_order
    i = 1
    ζ = FastMultipole.get_ζ(ζs_test,n)
    for m in 0:n
        for mp in 0:n
            ζ_check = (1.0im)^(1.0*(mp-m)) * sqrt(factorial(n-mp)*factorial(n+mp)/factorial(n-m)/factorial(n+m))
            ζ_real, ζ_imag = FastMultipole.ζ_sign(ζ[i], mp, m)
            @test isapprox(ζ_real, real(ζ_check); atol=1e-12)
            @test isapprox(ζ_imag, imag(ζ_check); atol=1e-12)
            i += 1
        end
    end
end

end

@testset "multipole rotation about y axis" begin

# y axis rotation
θ = 1.0114070854293842
unrotated_weights_real = [  0.7
 -0.07000000000000005
 -0.02450000000000005
 -0.004357499999999994
  0.0024500000000000064
 -0.0030712499999999954
  0.0006690833333333335
  1.5006249999999857e-5
  0.0003071249999999999
  0.0001174979166666668
 -1.4320723958333386e-5
 -9.667291666666687e-6
 -3.864656250000024e-6
 -1.1749791666666693e-5
  8.166848958333223e-7
 -9.537609374999984e-7
  3.281966406250014e-7
 -6.372843749999987e-7
  2.5776105468750134e-7
 -8.166848958333231e-8
 -7.737929427083328e-8
  5.098179934895839e-8
  4.849085937499983e-9
  2.8536951269531264e-8
  1.3389866753472217e-8
  2.24996688802081e-9
  7.737929427083334e-9
  5.971821679687555e-10
 -2.8397680989583774e-10
 -5.067043185221367e-10
 -4.691387695312751e-11
 -7.88947717046443e-10
  4.723160980902693e-11
 -2.4213270832248304e-10
 -5.971821679687559e-11
  1.470871589626728e-11
 -3.707711827209467e-11
  7.838756504991373e-12
 -2.4938463487792926e-11
  8.151234378255282e-12
 -4.049387434705895e-12
 -1.5798272580294929e-12
  2.0282865776367417e-12
 -1.470871589626729e-12
 -2.484042968682189e-13
  9.706349126647221e-13
  1.811522628547496e-13
  5.840384386230481e-13
  4.0911293365021867e-13
  6.601451169976073e-14
  2.853355718849011e-13
 -3.767935107422065e-15
  5.2905412489386483e-14
  2.4840429686821914e-14
 -3.610962456860734e-16
  1.913274590750245e-15
 -7.823606379273242e-15
  2.702589709333745e-15
 -1.3459531223094847e-14
  1.1533785468548596e-15
 -6.0720676015399114e-15
 -1.628029006377425e-15
 -3.876359501828816e-16
 -9.32206125191568e-16
  3.610962456860736e-17
  3.3509209634755375e-17]

unrotated_weights_imag = [  0.0
  0.0
  0.06999999999999998
  0.0
 -0.007000000000000002
 -0.0024500000000000043
  0.0
 -4.2874999999999484e-5
  0.00024500000000000064
 -7.379166666666638e-5
  0.0
  2.7620833333333328e-5
 -3.082916666666695e-6
  7.379166666666646e-6
  3.583125000000001e-6
  0.0
 -9.377046875000017e-7
 -5.083750000000006e-7
 -1.6188046875e-7
 -3.583125000000005e-7
 -8.748177083333623e-9
  0.0
 -1.3854531249999918e-8
  2.276451953125008e-8
 -8.409175347222177e-9
  9.871509375000034e-9
  8.748177083333628e-10
 -1.2386238715277746e-9
  0.0
  1.4477266243489585e-9
 -3.7424175347224344e-11
  4.95479142144096e-10
  2.0722406249999916e-10
 -2.737450412326486e-11
  1.2386238715277758e-10
  1.4724293185763965e-11
  0.0
 -2.2396447157118155e-11
 -1.9893930987413222e-11
 -5.119181575520854e-12
 -1.776629080078127e-11
 -1.7860861545139256e-13
 -4.2068975065104154e-12
 -1.4724293185763973e-12
  1.1944016601562344e-13
  0.0
 -5.175778938707118e-13
  4.658996091579886e-13
 -2.5693328090729754e-13
  2.8963220507812656e-13
  3.225883790418944e-14
  7.815126808449379e-15
  5.296144205254486e-14
 -1.1944016601562353e-14
 -3.224537277485413e-15
  0.0
  2.2353161083637787e-14
  2.1559120188417408e-15
  8.452926398021546e-15
  5.0603354204101325e-15
 -6.864823870623804e-16
  3.3767176901776252e-15
 -3.8804647666649204e-16
  4.482324007975212e-16
  3.224537277485415e-16
  7.674918014338235e-18]

unrotated_weights_test = unrotated_weights_real + im .* unrotated_weights_imag

rotated_weights_test = ComplexF64[0.6999999999999998 + 0.0im, -0.02450000000000002 - 0.007481525851955773im, -0.15580791726900806 + 0.0im, 0.024500000000000022 - 0.007481525851955773im, 0.00038876912209037044 + 0.0002618534048184518im, 0.005453277104415287 + 0.0016652585156963855im, 0.016402614732542217 - 8.673617379884035e-19im, -0.0054532771044152875 + 0.001665258515696389im, 0.00038876912209036946 - 0.0002618534048184527im, -3.602752606496274e-6 - 4.439997454958801e-6im, -8.653329601628727e-5 - 5.82840480493738e-5im, -0.0005904970963658152 - 0.00018031915477410956im, -0.001077871100883933 - 1.3552527156068805e-19im, 0.000590497096365815 - 0.00018031915477410967im, -8.653329601628759e-5 + 5.8284048049373535e-5im, 3.6027526064962993e-6 - 4.439997454958801e-6im, 1.9660529684739974e-8 + 4.8476437289352107e-8im, 8.019105429338163e-7 + 9.882667944811644e-7im, 9.456858455370194e-6 + 6.369617453438692e-6im, 4.137708762327631e-5 + 1.263525513192579e-5im, 4.868156026970106e-5 + 1.6940658945086007e-21im, -4.1377087623276345e-5 + 1.2635255131925818e-5im, 9.456858455370145e-6 - 6.369617453438696e-6im, -8.019105429338041e-7 + 9.882667944811746e-7im, 1.9660529684736635e-8 - 4.8476437289348586e-8im, -3.400150242417064e-11 - 3.8136099276822473e-10im, -4.376094546548907e-9 - 1.0790018186679514e-8im, -8.803949295603147e-8 - 1.0849901932089361e-7im, -6.758915790915228e-7 - 4.552432310508834e-7im, -2.1029224520131654e-6 - 6.421660689548863e-7im, -1.5338380701874728e-6 + 4.764560328305439e-22im, 2.1029224520131688e-6 - 6.421660689548861e-7im, -6.758915790915228e-7 + 4.5524323105088197e-7im, 8.8039492956031e-8 - 1.0849901932089344e-7im, -4.376094546549466e-9 + 1.079001818667933e-8im, 3.400150242449052e-11 - 3.813609927681869e-10im, -4.809822183141521e-13 + 2.2851732005260972e-12im, 7.568147538202057e-12 + 8.488437430122872e-11im, 4.817555565705049e-10 + 1.1878516703960255e-9im, 6.3530332390973366e-9 + 7.829416697110508e-9im, 3.5489945588265515e-8 + 2.3904066864005507e-8im, 8.22061291562435e-8 + 2.5103154304965308e-8im, 3.0079083548311814e-8 + 8.271806125530277e-24im, -8.220612915624352e-8 + 2.5103154304965325e-8im, 3.5489945588265455e-8 - 2.3904066864005537e-8im, -6.353033239097363e-9 + 7.829416697110505e-9im, 4.817555565704706e-10 - 1.1878516703960408e-9im, -7.568147538208584e-12 + 8.488437430122405e-11im, -4.809822183157816e-13 - 2.2851732005270092e-12im, 5.894009535640342e-15 - 1.069148214536192e-14im, 1.0705833954164472e-13 - 5.086401099614011e-13im, -8.346801924698897e-13 - 9.36177651423503e-12im, -3.496207685291585e-11 - 8.620504906242062e-11im, -3.387403461042358e-10 - 4.174603251643576e-10im, -1.4574754030091342e-9 - 9.816749197184837e-10im, -2.550400154365841e-9 - 7.788116199069463e-10im, -5.772229317766553e-11 - 1.4475660719677984e-24im, 2.5504001543658364e-9 - 7.788116199069458e-10im, -1.457475403009133e-9 + 9.816749197184831e-10im, 3.387403461042395e-10 - 4.17460325164358e-10im, -3.496207685291607e-11 + 8.620504906241973e-11im, 8.346801924694567e-13 - 9.361776514234701e-12im, 1.070583395417875e-13 + 5.086401099612161e-13im, -5.894009535678703e-15 - 1.0691482145364523e-14im, -4.0069970302383206e-17 + 3.890091568620404e-17im, -1.3119047858751144e-15 + 2.3797393794103016e-15im, -1.182264831653405e-14 + 5.6170057984299394e-14im, 6.080230130861824e-14 + 6.819588646489233e-13im, 1.880852965142075e-12 + 4.637568380773762e-12im, 1.422154155698053e-11 + 1.7526490218819616e-11im, 4.8628916577330294e-11 + 3.2753751918205186e-11im, 6.352395692380978e-11 + 1.9398209222204483e-11im, -2.279096711074956e-11 - 2.3224065049706588e-26im, -6.35239569238098e-11 + 1.93982092222045e-11im, 4.862891657733026e-11 - 3.275375191820517e-11im, -1.4221541556980539e-11 + 1.752649021881964e-11im, 1.8808529651420723e-12 - 4.637568380773705e-12im, -6.08023013086046e-14 + 6.819588646489298e-13im, -1.1822648316533931e-14 - 5.617005798429622e-14im, 1.3119047858764937e-15 + 2.3797393794123976e-15im, -4.006997030261087e-17 - 3.890091568681754e-17im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]

# rotate about y axis
expansion_order = 10
Hs_π2 = [1.0]
FastMultipole.update_Hs_π2!(Hs_π2, Val(expansion_order))
ζs_mag = zeros(FastMultipole.length_ζs(expansion_order))
FastMultipole.update_ζs_mag!(ζs_mag, 0, expansion_order)
Ts = zeros(FastMultipole.length_Ts(expansion_order))
lamb_helmholtz = Val(false)

source_weights = initialize_expansion(expansion_order, eltype(Ts))
source_weights[1,1,:] .= unrotated_weights_real[1:size(source_weights,3)]
source_weights[2,1,:] .= unrotated_weights_imag[1:size(source_weights,3)]
rotated_weights = initialize_expansion(expansion_order, eltype(Ts))

FastMultipole.rotate_multipole_y!(rotated_weights, source_weights, Ts, Hs_π2, ζs_mag, θ, expansion_order, lamb_helmholtz)

i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            @test isapprox(rotated_weights[1,1,i_compressed], real(rotated_weights_test[i]); atol=3e-12)
            @test isapprox(rotated_weights[2,1,i_compressed], imag(rotated_weights_test[i]); atol=3e-12)
            i_compressed += 1
        end
        i += 1
    end
end

end

@testset "multipole back rotation about y axis" begin

# y axis rotation
θ = 1.0114070854293842
unrotated_weights_real = [  0.7
 -0.07000000000000005
 -0.02450000000000005
 -0.004357499999999994
  0.0024500000000000064
 -0.0030712499999999954
  0.0006690833333333335
  1.5006249999999857e-5
  0.0003071249999999999
  0.0001174979166666668
 -1.4320723958333386e-5
 -9.667291666666687e-6
 -3.864656250000024e-6
 -1.1749791666666693e-5
  8.166848958333223e-7
 -9.537609374999984e-7
  3.281966406250014e-7
 -6.372843749999987e-7
  2.5776105468750134e-7
 -8.166848958333231e-8
 -7.737929427083328e-8
  5.098179934895839e-8
  4.849085937499983e-9
  2.8536951269531264e-8
  1.3389866753472217e-8
  2.24996688802081e-9
  7.737929427083334e-9
  5.971821679687555e-10
 -2.8397680989583774e-10
 -5.067043185221367e-10
 -4.691387695312751e-11
 -7.88947717046443e-10
  4.723160980902693e-11
 -2.4213270832248304e-10
 -5.971821679687559e-11
  1.470871589626728e-11
 -3.707711827209467e-11
  7.838756504991373e-12
 -2.4938463487792926e-11
  8.151234378255282e-12
 -4.049387434705895e-12
 -1.5798272580294929e-12
  2.0282865776367417e-12
 -1.470871589626729e-12
 -2.484042968682189e-13
  9.706349126647221e-13
  1.811522628547496e-13
  5.840384386230481e-13
  4.0911293365021867e-13
  6.601451169976073e-14
  2.853355718849011e-13
 -3.767935107422065e-15
  5.2905412489386483e-14
  2.4840429686821914e-14
 -3.610962456860734e-16
  1.913274590750245e-15
 -7.823606379273242e-15
  2.702589709333745e-15
 -1.3459531223094847e-14
  1.1533785468548596e-15
 -6.0720676015399114e-15
 -1.628029006377425e-15
 -3.876359501828816e-16
 -9.32206125191568e-16
  3.610962456860736e-17
  3.3509209634755375e-17]

unrotated_weights_imag = [  0.0
  0.0
  0.06999999999999998
  0.0
 -0.007000000000000002
 -0.0024500000000000043
  0.0
 -4.2874999999999484e-5
  0.00024500000000000064
 -7.379166666666638e-5
  0.0
  2.7620833333333328e-5
 -3.082916666666695e-6
  7.379166666666646e-6
  3.583125000000001e-6
  0.0
 -9.377046875000017e-7
 -5.083750000000006e-7
 -1.6188046875e-7
 -3.583125000000005e-7
 -8.748177083333623e-9
  0.0
 -1.3854531249999918e-8
  2.276451953125008e-8
 -8.409175347222177e-9
  9.871509375000034e-9
  8.748177083333628e-10
 -1.2386238715277746e-9
  0.0
  1.4477266243489585e-9
 -3.7424175347224344e-11
  4.95479142144096e-10
  2.0722406249999916e-10
 -2.737450412326486e-11
  1.2386238715277758e-10
  1.4724293185763965e-11
  0.0
 -2.2396447157118155e-11
 -1.9893930987413222e-11
 -5.119181575520854e-12
 -1.776629080078127e-11
 -1.7860861545139256e-13
 -4.2068975065104154e-12
 -1.4724293185763973e-12
  1.1944016601562344e-13
  0.0
 -5.175778938707118e-13
  4.658996091579886e-13
 -2.5693328090729754e-13
  2.8963220507812656e-13
  3.225883790418944e-14
  7.815126808449379e-15
  5.296144205254486e-14
 -1.1944016601562353e-14
 -3.224537277485413e-15
  0.0
  2.2353161083637787e-14
  2.1559120188417408e-15
  8.452926398021546e-15
  5.0603354204101325e-15
 -6.864823870623804e-16
  3.3767176901776252e-15
 -3.8804647666649204e-16
  4.482324007975212e-16
  3.224537277485415e-16
  7.674918014338235e-18]

unrotated_weights_test = unrotated_weights_real + im .* unrotated_weights_imag

# rotate about y axis
expansion_order = 10
Hs_π2 = [1.0]
FastMultipole.update_Hs_π2!(Hs_π2, Val(expansion_order))
ζs_mag = zeros(FastMultipole.length_ζs(expansion_order))
FastMultipole.update_ζs_mag!(ζs_mag, 0, expansion_order)
Ts = zeros(FastMultipole.length_Ts(expansion_order))
lamb_helmholtz = Val(false)

source_weights = initialize_expansion(expansion_order, eltype(Ts))
source_weights[1,1,:] .= unrotated_weights_real[1:size(source_weights,3)]
source_weights[2,1,:] .= unrotated_weights_imag[1:size(source_weights,3)]
rotated_weights = initialize_expansion(expansion_order, eltype(Ts))
back_rotated_weights = initialize_expansion(expansion_order, eltype(Ts))

FastMultipole.rotate_multipole_y!(rotated_weights, source_weights, Ts, Hs_π2, ζs_mag, θ, expansion_order, lamb_helmholtz)
FastMultipole.back_rotate_multipole_y!(back_rotated_weights, rotated_weights, Ts, ζs_mag, expansion_order, lamb_helmholtz)

i_compressed = 1
for n in 0:expansion_order
    for m in 0:n
        @test isapprox(back_rotated_weights[1,1,i_compressed], source_weights[1,1,i_compressed]; atol=1e-12)
        @test isapprox(back_rotated_weights[2,1,i_compressed], source_weights[2,1,i_compressed]; atol=1e-12)
        i_compressed += 1
    end
end

end

@testset "multipole rotation about z axis" begin

# rotation about z axis

unrotated_weights_test = ComplexF64[0.7 + 0.0im, 0.024500000000000015 + 0.06999999999999999im, -0.07000000000000005 - 0.0im, -0.024500000000000015 + 0.06999999999999999im, -0.0030712499999999985 + 0.002450000000000001im, -0.0024500000000000034 - 0.007000000000000005im, -0.004357499999999994 - 0.0im, 0.0024500000000000034 - 0.007000000000000005im, -0.0030712499999999985 - 0.002450000000000001im, -0.00011749791666666669 - 7.379166666666664e-5im, 0.0003071250000000001 - 0.00024500000000000026im, -1.500624999999978e-5 - 4.287499999999935e-5im, 0.0006690833333333336 - 0.0im, 1.500624999999978e-5 - 4.287499999999935e-5im, 0.0003071250000000001 + 0.00024500000000000026im, 0.00011749791666666669 - 7.379166666666664e-5im, 8.166848958333306e-7 - 3.5831250000000026e-6im, 1.1749791666666666e-5 + 7.379166666666662e-6im, -3.864656250000026e-6 + 3.08291666666669e-6im, 9.66729166666667e-6 + 2.7620833333333328e-5im, -1.4320723958333388e-5 - 0.0im, -9.66729166666667e-6 + 2.7620833333333328e-5im, -3.864656250000026e-6 - 3.08291666666669e-6im, -1.1749791666666666e-5 + 7.379166666666662e-6im, 8.166848958333306e-7 + 3.5831250000000026e-6im, 7.737929427083341e-8 - 8.748177083333462e-9im, -8.16684895833331e-8 + 3.583125000000005e-7im, -2.5776105468750124e-7 - 1.618804687500007e-7im, -6.372843749999988e-7 + 5.083749999999995e-7im, -3.281966406250009e-7 - 9.377046875000021e-7im, -9.537609374999984e-7 - 0.0im, 3.281966406250009e-7 - 9.377046875000021e-7im, -6.372843749999988e-7 - 5.083749999999995e-7im, 2.5776105468750124e-7 - 1.618804687500007e-7im, -8.16684895833331e-8 - 3.583125000000005e-7im, -7.737929427083341e-8 - 8.748177083333462e-9im, 5.971821679687503e-10 + 1.2386238715277772e-9im, -7.73792942708335e-9 + 8.748177083333471e-10im, 2.2499668880208317e-9 - 9.871509375000034e-9im, -1.338986675347222e-8 - 8.409175347222217e-9im, 2.8536951269531337e-8 - 2.276451953125009e-8im, -4.849085937499971e-9 - 1.385453124999991e-8im, 5.09817993489584e-8 + 0.0im, 4.849085937499971e-9 - 1.385453124999991e-8im, 2.8536951269531337e-8 + 2.276451953125009e-8im, 1.338986675347222e-8 - 8.409175347222217e-9im, 2.2499668880208317e-9 + 9.871509375000034e-9im, 7.73792942708335e-9 + 8.748177083333471e-10im, 5.971821679687503e-10 - 1.2386238715277772e-9im, -1.4708715896267304e-11 + 1.4724293185763917e-11im, -5.971821679687514e-11 - 1.2386238715277795e-10im, 2.4213270832248356e-10 - 2.7374504123264368e-11im, 4.723160980902741e-11 - 2.0722406249999924e-10im, 7.889477170464424e-10 + 4.954791421440979e-10im, -4.69138769531276e-11 + 3.7424175347224324e-11im, 5.067043185221363e-10 + 1.4477266243489603e-9im, -2.839768098958378e-10 - 0.0im, -5.067043185221363e-10 + 1.4477266243489603e-9im, -4.69138769531276e-11 - 3.7424175347224324e-11im, -7.889477170464424e-10 + 4.954791421440979e-10im, 4.723160980902741e-11 + 2.0722406249999924e-10im, -2.4213270832248356e-10 - 2.7374504123264368e-11im, -5.971821679687514e-11 + 1.2386238715277795e-10im, 1.4708715896267304e-11 + 1.4724293185763917e-11im, -2.484042968682193e-13 - 1.1944016601562495e-13im, 1.4708715896267301e-12 - 1.4724293185763915e-12im, 2.0282865776367263e-12 + 4.2068975065104275e-12im, 1.579827258029496e-12 - 1.7860861545138933e-13im, -4.049387434705927e-12 + 1.776629080078124e-11im, -8.151234378255274e-12 - 5.119181575520872e-12im, -2.493846348779296e-11 + 1.9893930987413206e-11im, -7.838756504991368e-12 - 2.2396447157118177e-11im, -3.707711827209468e-11 - 0.0im, 7.838756504991368e-12 - 2.2396447157118177e-11im, -2.493846348779296e-11 - 1.9893930987413206e-11im, 8.151234378255274e-12 - 5.119181575520872e-12im, -4.049387434705927e-12 - 1.776629080078124e-11im, -1.579827258029496e-12 - 1.7860861545138933e-13im, 2.0282865776367263e-12 - 4.2068975065104275e-12im, -1.4708715896267301e-12 - 1.4724293185763915e-12im, -2.484042968682193e-13 + 1.1944016601562495e-13im, 3.6109624568609173e-16 - 3.2245372774853964e-15im, 2.4840429686821864e-14 + 1.1944016601562465e-14im, -5.2905412489386723e-14 + 5.2961442052544834e-14im, -3.7679351074220416e-15 - 7.815126808449412e-15im, -2.853355718849014e-13 + 3.2258837904188824e-14im, 6.601451169976129e-14 - 2.896322050781262e-13im, -4.091129336502179e-13 - 2.569332809072982e-13im, 5.840384386230494e-13 - 4.658996091579884e-13im, -1.8115226285474907e-13 - 5.175778938707113e-13im, 9.706349126647223e-13 - 0.0im, 1.8115226285474907e-13 - 5.175778938707113e-13im, 5.840384386230494e-13 + 4.658996091579884e-13im, 4.091129336502179e-13 - 2.569332809072982e-13im, 6.601451169976129e-14 + 2.896322050781262e-13im, 2.853355718849014e-13 + 3.2258837904188824e-14im, -3.7679351074220416e-15 + 7.815126808449412e-15im, 5.2905412489386723e-14 + 5.2961442052544834e-14im, 2.4840429686821864e-14 - 1.1944016601562465e-14im, -3.6109624568609173e-16 - 3.2245372774853964e-15im, 3.3509209634755437e-17 - 7.674918014338092e-18im, -3.610962456860927e-17 + 3.2245372774854055e-16im, -9.322061251915687e-16 - 4.482324007975264e-16im, 3.876359501828815e-16 - 3.880464766664901e-16im, -1.6280290063774146e-15 - 3.3767176901776394e-15im, 6.072067601539915e-15 - 6.86482387062367e-16im, 1.153378546854868e-15 - 5.060335420410121e-15im, 1.345953122309482e-14 + 8.452926398021565e-15im, 2.70258970933374e-15 - 2.155912018841732e-15im, 7.823606379273228e-15 + 2.2353161083637778e-14im, 1.9132745907502454e-15 + 0.0im, -7.823606379273228e-15 + 2.2353161083637778e-14im, 2.70258970933374e-15 + 2.155912018841732e-15im, -1.345953122309482e-14 + 8.452926398021565e-15im, 1.153378546854868e-15 + 5.060335420410121e-15im, -6.072067601539915e-15 - 6.86482387062367e-16im, -1.6280290063774146e-15 + 3.3767176901776394e-15im, -3.876359501828815e-16 - 3.880464766664901e-16im, -9.322061251915687e-16 + 4.482324007975264e-16im, 3.610962456860927e-17 + 3.2245372774854055e-16im, 3.3509209634755437e-17 + 7.674918014338092e-18im]

rotated_weights_test = ComplexF64[0.6999999999999998 + 0.0im, 0.07356663645974308 + 0.00939148550549909im, -0.07000000000000006 + 9.009314586446133e-18im, -0.0735666364597431 + 0.009391485505499097im, 0.0038027499999999997 + 0.0009869999999999983im, -0.007356663645974312 - 0.0009391485505499102im, -0.004357499999999996 + 2.637457412787555e-19im, 0.007356663645974317 - 0.0009391485505499127im, 0.00380275 - 0.0009869999999999994im, 0.00012880291933493353 + 5.158273413895388e-5im, -0.0003802750000000006 - 9.869999999999992e-5im, -4.50595648315918e-5 - 5.752284872117967e-6im, 0.0006690833333333335 + 8.675680751046035e-20im, 4.5059564831592004e-5 - 5.752284872117767e-6im, -0.00038027500000000007 + 9.87e-5im, -0.00012880291933493366 + 5.1582734138954017e-5im, 3.2111282291666756e-6 + 1.7872925000000003e-6im, -1.2880291933493335e-5 - 5.158273413895395e-6im, 4.78512708333336e-6 + 1.2419750000000109e-6im, 2.9028168636406923e-5 + 3.7057236557115245e-6im, -1.4320723958333367e-5 + 6.4250210433843526e-21im, -2.9028168636406936e-5 + 3.70572365571156e-6im, 4.785127083333389e-6 - 1.2419750000000007e-6im, 1.2880291933493362e-5 - 5.1582734138954055e-6im, 3.2111282291666705e-6 - 1.787292500000003e-6im, 6.269902041511043e-8 + 4.618353194721218e-8im, -3.211128229166685e-7 - 1.787292499999997e-7im, 2.825614042910119e-7 + 1.1315962301733049e-7im, 7.890706249999994e-7 + 2.0480250000000002e-7im, -9.854825693129947e-7 - 1.2580628544421122e-7im, -9.537609374999963e-7 + 4.284228354056486e-22im, 9.854825693129964e-7 - 1.2580628544421135e-7im, 7.890706250000004e-7 - 2.0480249999999952e-7im, -2.825614042910117e-7 + 1.1315962301733097e-7im, -3.211128229166678e-7 + 1.7872924999999973e-7im, -6.269902041511043e-8 + 4.618353194721233e-8im, 9.949581119965314e-10 + 9.49143820624992e-10im, -6.269902041511032e-9 - 4.61835319472122e-9im, 8.846658271354204e-9 + 4.9239908374999985e-9im, 1.467816601587685e-8 + 5.878282411251627e-9im, -3.5333786386718896e-8 - 9.170849296875032e-9im, -1.4560446625555612e-8 - 1.8587804202836614e-9im, 5.098179934895853e-8 + 5.335346102440075e-24im, 1.4560446625555649e-8 - 1.858780420283675e-9im, -3.533378638671889e-8 + 9.170849296875067e-9im, -1.4678166015876821e-8 + 5.878282411251662e-9im, 8.846658271354223e-9 - 4.923990837499989e-9im, 6.26990204151103e-9 - 4.61835319472124e-9im, 9.949581119965234e-10 - 9.491438206249988e-10im, 1.3118745159976949e-11 + 1.6157031242311365e-11im, -9.949581119965295e-11 - 9.491438206250053e-11im, 1.9619568471561718e-10 + 1.4451596871815227e-10im, 1.8571024925347268e-10 + 1.0336508291666502e-10im, -8.648559229054128e-10 - 3.463557609569633e-10im, 5.808766644965841e-11 + 1.5076596354166734e-11im, 1.521491118093874e-9 + 1.94232908692834e-10im, -2.839768098958377e-10 + 1.1763750769804815e-25im, -1.5214911180938743e-9 + 1.9423290869283044e-10im, 5.808766644965508e-11 - 1.5076596354169355e-11im, 8.648559229054095e-10 - 3.463557609569635e-10im, 1.8571024925347226e-10 - 1.0336508291666537e-10im, -1.9619568471561576e-10 + 1.4451596871815292e-10im, -9.949581119965303e-11 + 9.491438206250083e-11im, -1.3118745159976957e-11 + 1.6157031242311297e-11im, 1.4524346986928488e-13 + 2.342540979807253e-13im, -1.3118745159977097e-12 - 1.6157031242311082e-12im, 3.3793041589596467e-12 + 3.2236991907656166e-12im, 1.2801050001417916e-12 + 9.429137772556192e-13im, -1.5921810687032315e-11 - 8.86197336153646e-12im, 8.935501274299647e-12 + 3.5784715828679096e-12im, 3.0878222882606356e-11 + 8.014412197786443e-12im, -2.353758979996513e-11 - 3.004798697867871e-12im, -3.707711827209475e-11 - 2.41871966837096e-26im, 2.3537589799965118e-11 - 3.004798697867923e-12im, 3.0878222882606285e-11 - 8.014412197786422e-12im, -8.935501274299619e-12 + 3.5784715828678717e-12im, -1.5921810687032328e-11 + 8.861973361536493e-12im, -1.280105000141817e-12 + 9.429137772555933e-13im, 3.379304158959657e-12 - 3.223699190765613e-12im, 1.3118745159977057e-12 - 1.61570312423111e-12im, 1.4524346986928316e-13 - 2.3425409798072654e-13im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]
ϕ = 1.1071487177940904

expansion_order = 10
unrotated_weights = initialize_expansion(expansion_order, Float64)
rotated_weights = initialize_expansion(expansion_order, Float64)
lamb_helmholtz = Val(false)
i_compressed = 1
i = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            unrotated_weights[1,1,i_compressed] = real(unrotated_weights_test[i])
            unrotated_weights[2,1,i_compressed] = imag(unrotated_weights_test[i])
            i_compressed += 1
        end
        i += 1
    end
end

eimϕs = zeros(2,expansion_order+1)
FastMultipole.rotate_z!(rotated_weights, unrotated_weights, eimϕs, ϕ, expansion_order, lamb_helmholtz)

i_compressed = 1
i = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            @test isapprox(rotated_weights[1,1,i_compressed], real(rotated_weights_test[i]); atol=1e-12)
            @test isapprox(rotated_weights[2,1,i_compressed], imag(rotated_weights_test[i]); atol=1e-12)
            i_compressed += 1
        end
        i += 1
    end
end

end

@testset "multipole back rotation about z axis" begin

# rotation about z axis

unrotated_weights_test = ComplexF64[0.7 + 0.0im, 0.024500000000000015 + 0.06999999999999999im, -0.07000000000000005 - 0.0im, -0.024500000000000015 + 0.06999999999999999im, -0.0030712499999999985 + 0.002450000000000001im, -0.0024500000000000034 - 0.007000000000000005im, -0.004357499999999994 - 0.0im, 0.0024500000000000034 - 0.007000000000000005im, -0.0030712499999999985 - 0.002450000000000001im, -0.00011749791666666669 - 7.379166666666664e-5im, 0.0003071250000000001 - 0.00024500000000000026im, -1.500624999999978e-5 - 4.287499999999935e-5im, 0.0006690833333333336 - 0.0im, 1.500624999999978e-5 - 4.287499999999935e-5im, 0.0003071250000000001 + 0.00024500000000000026im, 0.00011749791666666669 - 7.379166666666664e-5im, 8.166848958333306e-7 - 3.5831250000000026e-6im, 1.1749791666666666e-5 + 7.379166666666662e-6im, -3.864656250000026e-6 + 3.08291666666669e-6im, 9.66729166666667e-6 + 2.7620833333333328e-5im, -1.4320723958333388e-5 - 0.0im, -9.66729166666667e-6 + 2.7620833333333328e-5im, -3.864656250000026e-6 - 3.08291666666669e-6im, -1.1749791666666666e-5 + 7.379166666666662e-6im, 8.166848958333306e-7 + 3.5831250000000026e-6im, 7.737929427083341e-8 - 8.748177083333462e-9im, -8.16684895833331e-8 + 3.583125000000005e-7im, -2.5776105468750124e-7 - 1.618804687500007e-7im, -6.372843749999988e-7 + 5.083749999999995e-7im, -3.281966406250009e-7 - 9.377046875000021e-7im, -9.537609374999984e-7 - 0.0im, 3.281966406250009e-7 - 9.377046875000021e-7im, -6.372843749999988e-7 - 5.083749999999995e-7im, 2.5776105468750124e-7 - 1.618804687500007e-7im, -8.16684895833331e-8 - 3.583125000000005e-7im, -7.737929427083341e-8 - 8.748177083333462e-9im, 5.971821679687503e-10 + 1.2386238715277772e-9im, -7.73792942708335e-9 + 8.748177083333471e-10im, 2.2499668880208317e-9 - 9.871509375000034e-9im, -1.338986675347222e-8 - 8.409175347222217e-9im, 2.8536951269531337e-8 - 2.276451953125009e-8im, -4.849085937499971e-9 - 1.385453124999991e-8im, 5.09817993489584e-8 + 0.0im, 4.849085937499971e-9 - 1.385453124999991e-8im, 2.8536951269531337e-8 + 2.276451953125009e-8im, 1.338986675347222e-8 - 8.409175347222217e-9im, 2.2499668880208317e-9 + 9.871509375000034e-9im, 7.73792942708335e-9 + 8.748177083333471e-10im, 5.971821679687503e-10 - 1.2386238715277772e-9im, -1.4708715896267304e-11 + 1.4724293185763917e-11im, -5.971821679687514e-11 - 1.2386238715277795e-10im, 2.4213270832248356e-10 - 2.7374504123264368e-11im, 4.723160980902741e-11 - 2.0722406249999924e-10im, 7.889477170464424e-10 + 4.954791421440979e-10im, -4.69138769531276e-11 + 3.7424175347224324e-11im, 5.067043185221363e-10 + 1.4477266243489603e-9im, -2.839768098958378e-10 - 0.0im, -5.067043185221363e-10 + 1.4477266243489603e-9im, -4.69138769531276e-11 - 3.7424175347224324e-11im, -7.889477170464424e-10 + 4.954791421440979e-10im, 4.723160980902741e-11 + 2.0722406249999924e-10im, -2.4213270832248356e-10 - 2.7374504123264368e-11im, -5.971821679687514e-11 + 1.2386238715277795e-10im, 1.4708715896267304e-11 + 1.4724293185763917e-11im, -2.484042968682193e-13 - 1.1944016601562495e-13im, 1.4708715896267301e-12 - 1.4724293185763915e-12im, 2.0282865776367263e-12 + 4.2068975065104275e-12im, 1.579827258029496e-12 - 1.7860861545138933e-13im, -4.049387434705927e-12 + 1.776629080078124e-11im, -8.151234378255274e-12 - 5.119181575520872e-12im, -2.493846348779296e-11 + 1.9893930987413206e-11im, -7.838756504991368e-12 - 2.2396447157118177e-11im, -3.707711827209468e-11 - 0.0im, 7.838756504991368e-12 - 2.2396447157118177e-11im, -2.493846348779296e-11 - 1.9893930987413206e-11im, 8.151234378255274e-12 - 5.119181575520872e-12im, -4.049387434705927e-12 - 1.776629080078124e-11im, -1.579827258029496e-12 - 1.7860861545138933e-13im, 2.0282865776367263e-12 - 4.2068975065104275e-12im, -1.4708715896267301e-12 - 1.4724293185763915e-12im, -2.484042968682193e-13 + 1.1944016601562495e-13im, 3.6109624568609173e-16 - 3.2245372774853964e-15im, 2.4840429686821864e-14 + 1.1944016601562465e-14im, -5.2905412489386723e-14 + 5.2961442052544834e-14im, -3.7679351074220416e-15 - 7.815126808449412e-15im, -2.853355718849014e-13 + 3.2258837904188824e-14im, 6.601451169976129e-14 - 2.896322050781262e-13im, -4.091129336502179e-13 - 2.569332809072982e-13im, 5.840384386230494e-13 - 4.658996091579884e-13im, -1.8115226285474907e-13 - 5.175778938707113e-13im, 9.706349126647223e-13 - 0.0im, 1.8115226285474907e-13 - 5.175778938707113e-13im, 5.840384386230494e-13 + 4.658996091579884e-13im, 4.091129336502179e-13 - 2.569332809072982e-13im, 6.601451169976129e-14 + 2.896322050781262e-13im, 2.853355718849014e-13 + 3.2258837904188824e-14im, -3.7679351074220416e-15 + 7.815126808449412e-15im, 5.2905412489386723e-14 + 5.2961442052544834e-14im, 2.4840429686821864e-14 - 1.1944016601562465e-14im, -3.6109624568609173e-16 - 3.2245372774853964e-15im, 3.3509209634755437e-17 - 7.674918014338092e-18im, -3.610962456860927e-17 + 3.2245372774854055e-16im, -9.322061251915687e-16 - 4.482324007975264e-16im, 3.876359501828815e-16 - 3.880464766664901e-16im, -1.6280290063774146e-15 - 3.3767176901776394e-15im, 6.072067601539915e-15 - 6.86482387062367e-16im, 1.153378546854868e-15 - 5.060335420410121e-15im, 1.345953122309482e-14 + 8.452926398021565e-15im, 2.70258970933374e-15 - 2.155912018841732e-15im, 7.823606379273228e-15 + 2.2353161083637778e-14im, 1.9132745907502454e-15 + 0.0im, -7.823606379273228e-15 + 2.2353161083637778e-14im, 2.70258970933374e-15 + 2.155912018841732e-15im, -1.345953122309482e-14 + 8.452926398021565e-15im, 1.153378546854868e-15 + 5.060335420410121e-15im, -6.072067601539915e-15 - 6.86482387062367e-16im, -1.6280290063774146e-15 + 3.3767176901776394e-15im, -3.876359501828815e-16 - 3.880464766664901e-16im, -9.322061251915687e-16 + 4.482324007975264e-16im, 3.610962456860927e-17 + 3.2245372774854055e-16im, 3.3509209634755437e-17 + 7.674918014338092e-18im]

ϕ = 1.1071487177940904

expansion_order = 10
unrotated_weights = initialize_expansion(expansion_order, Float64)
rotated_weights = initialize_expansion(expansion_order, Float64)
back_rotated_weights = initialize_expansion(expansion_order, Float64)
i_compressed = 1
i = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            unrotated_weights[1,1,i_compressed] = real(unrotated_weights_test[i])
            unrotated_weights[2,1,i_compressed] = imag(unrotated_weights_test[i])
            i_compressed += 1
        end
        i += 1
    end
end

lamb_helmholtz = Val(false)
eimϕs = zeros(2,expansion_order+1)
FastMultipole.rotate_z!(rotated_weights, unrotated_weights, eimϕs, ϕ, expansion_order, lamb_helmholtz)
FastMultipole.back_rotate_z!(back_rotated_weights, rotated_weights, eimϕs, expansion_order, lamb_helmholtz)

i_compressed = 1
i = 1
for n in 0:expansion_order
    for m in 0:n
        @test isapprox(back_rotated_weights[1,1,i], unrotated_weights[1,1,i]; atol=1e-12)
        @test isapprox(back_rotated_weights[2,1,i], unrotated_weights[2,1,i]; atol=1e-12)
        i_compressed += 1
    end
end

end

#------- LOCAL ROTATIONS -------#

#--- η ---#

@testset "η normalization" begin

# test η_sign
expansion_order = 4
for m in 0:expansion_order
    for mp in 0:expansion_order
        r, i = FastMultipole.η_sign(1.0, mp, m)
        check = (1.0im)^(1.0*m-mp)
        @test isapprox(r, real(check); atol=1e-12)
        @test isapprox(i, imag(check); atol=1e-12)
    end
end

ηs_test = zeros(FastMultipole.length_ηs(expansion_order))
ηs_test[1] = 1.0
FastMultipole.update_ηs_mag!(ηs_test, 0, expansion_order)
for n in 0:expansion_order
    i = 1
    η = FastMultipole.get_η(ηs_test,n)
    for m in 0:n
        for mp in 0:n
            η_check = (1.0im)^(1.0*(m-mp)) * sqrt(factorial(n-m)*factorial(n+m)/factorial(n-mp)/factorial(n+mp))
            η_real, η_imag = FastMultipole.η_sign(η[i], mp, m)
            @test isapprox(η_real, real(η_check); atol=1e-12)
            @test isapprox(η_imag, imag(η_check); atol=1e-12)
            i += 1
        end
    end
end

end

@testset "local rotation about y axis" begin

expansion_order = 10

weights_test = ComplexF64[0.12778297701763344 + 4.529689653984122e-19im, 0.01988565068340494 + 0.011071240208005997im, 0.005109803172606758 + 3.2526065174565133e-19im, -0.019885650683404945 + 0.011071240208006im, 0.006406175925111939 + 0.010337471580447111im, 0.002385570364972926 + 0.0013281548027035902im, -0.0036451747879949242 - 3.049318610115481e-20im, -0.0023855703649729256 + 0.0013281548027035898im, 0.006406175925111935 - 0.010337471580447108im, 0.0005064190184181157 + 0.0108187987474021im, 0.0012808552115572672 + 0.002066881133029694im, -0.0015110027367938065 - 0.0008412434953346443im, -0.00140992377229235 - 7.115076756936123e-20im, 0.0015110027367938065 - 0.0008412434953346439im, 0.0012808552115572695 - 0.002066881133029696im, -0.0005064190184181154 + 0.010818798747402106im, -0.00600979378232354 + 0.012092524633138818im, 0.00014175533778046622 + 0.0030283652269413376im, -0.0007088462454376961 - 0.0011438458938830946im, -0.001058918726541237 - 0.0005895478906568543im, 0.0006985665458948552 - 1.1779382795000135e-19im, 0.001058918726541237 - 0.0005895478906568545im, -0.0007088462454376964 + 0.0011438458938830957im, -0.00014175533778046644 + 0.0030283652269413363im, -0.006009793782323535 - 0.012092524633138793im, -0.017846596319110775 + 0.012250354186902287im, -0.0021628838222466995 + 0.00435201787134357im, -6.711258877263314e-5 - 0.001433749642424643im, -0.000767299139505339 - 0.0012381696520475816im, 0.00037417963078447444 + 0.00020832271843066228im, 0.0010031457155584922 + 1.2180317237904588e-19im, -0.0003741796307844752 + 0.00020832271843066233im, -0.0007672991395053396 + 0.001238169652047583im, 6.711258877263316e-5 - 0.0014337496424246432im, -0.0021628838222466987 - 0.004352017871343578im, 0.017846596319110775 + 0.012250354186902285im, -0.0422254692979453 + 0.0039617607195511755im, -0.007850172482929591 + 0.005388558288009481im, 0.000851017065931367 - 0.0017123618690188128im, -0.00010510135582031117 - 0.0022453119320058495im, 0.0001585337136231433 + 0.0002558216546230435im, 0.0010114739907600583 + 0.0005631332487366796im, -0.00014071294694094805 + 5.1777706484880617e-20im, -0.0010114739907600577 + 0.00056313324873668im, 0.000158533713623143 - 0.0002558216546230434im, 0.00010510135582031068 - 0.002245311932005849im, 0.0008510170659313671 + 0.0017123618690188147im, 0.007850172482929582 + 0.005388558288009473im, -0.042225469297945226 - 0.0039617607195511365im, -0.08988721063334315 - 0.03954501582849908im, -0.0219507296948253 + 0.0020595118239022173im, 0.0024609342549554544 - 0.0016892459109781428im, 0.00188389208320225 - 0.003790649516221961im, 5.746722439507631e-6 + 0.0001227763044802724im, 0.0009006229151328835 + 0.0014533104799389531im, 8.939703828641429e-5 + 4.977129351573298e-5im, -0.0012765669625816212 - 3.0557917426951705e-20im, -8.939703828641551e-5 + 4.9771293515732507e-5im, 0.0009006229151328834 - 0.0014533104799389518im, -5.7467224395056585e-6 + 0.00012277630448027281im, 0.001883892083202249 + 0.0037906495162219546im, -0.0024609342549554553 - 0.001689245910978146im, -0.021950729694825304 - 0.002059511823902216im, 0.08988721063334319 - 0.039545015828499064im, -0.15843120086296467 - 0.20912900046970154im, -0.053916337687050585 - 0.02371993084526941im, 0.0051257565765804244 - 0.00048091195635664084im, 0.007754397654929301 - 0.005322819104358317im, 0.00019415738394774093 - 0.00039067517018100925im, 0.00014354105250680534 + 0.003066505906362175im, 0.00030248360848619154 + 0.0004881087272936323im, -0.0015642563554373414 - 0.0008708921388456051im, -0.0005359500072129925 - 3.8273545140644316e-19im, 0.0015642563554373434 - 0.0008708921388456052im, 0.0003024836084861944 - 0.00048810872729363445im, -0.00014354105250680534 + 0.003066505906362176im, 0.0001941573839477417 + 0.0003906751701810133im, -0.007754397654929301 - 0.005322819104358313im, 0.005125756576580412 + 0.0004809119563566352im, 0.0539163376870506 - 0.023719930845269428im, -0.15843120086296497 + 0.20912900046970165im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]

rotated_weights_test = ComplexF64[0.12778297701763344 + 4.529689653984122e-19im, -0.019885650683404952 + 0.011930431692490973im, 0.0025193744931942307 - 8.673617379884035e-19im, 0.019885650683404945 + 0.011930431692490969im, 0.005942197679130063 - 0.01113971842826999im, -0.0011761989500464842 + 0.0007056626638456422im, -0.004109153033976794 - 1.6263032587282567e-18im, 0.0011761989500464884 + 0.0007056626638456403im, 0.005942197679130065 + 0.011139718428269994im, 0.000576648870009004 + 0.011441803168288111im, 0.0005857830848405143 - 0.001098155763921616im, 0.0018720253662695158 - 0.0011231249662401533im, -0.0007408981349946234 - 3.9810548520952116e-19im, -0.0018720253662695122 - 0.0011231249662401568im, 0.000585783084840505 + 0.0010981557639216147im, -0.0005766488700090121 + 0.011441803168288097im, -0.008106000111679428 - 0.01208718317679199im, 7.958463431428833e-5 + 0.0015791094866532758im, -0.000909227295655526 + 0.0017045101140383627im, 0.000571922541553128 - 0.0003431259518988544im, 0.0011301272553897019 + 1.0842021724855044e-19im, -0.0005719225415531302 - 0.00034312595189885597im, -0.0009092272956555333 - 0.0017045101140383651im, -7.958463431427204e-5 + 0.001579109486653281im, -0.008106000111679421 + 0.012087183176792008im, 0.021509795286519688 + 0.010117786891757258im, -0.0014383641626404663 - 0.0021448027126433067im, -0.00012038964667837018 - 0.0023887582016687667im, -0.00039558101178137437 + 0.0007415877649552499im, -0.0008342506452508623 + 0.0005005101661127942im, 0.0005955632051110156 + 6.166399856011306e-19im, 0.0008342506452508643 + 0.0005005101661127966im, -0.0003955810117813741 - 0.0007415877649552507im, 0.00012038964667837174 - 0.002388758201668767im, -0.001438364162640469 + 0.0021448027126433006im, -0.021509795286519705 + 0.010117786891757253im, -0.047212117307697185 + 0.00477094545025394im, 0.004664968526149511 + 0.0021943099151750245im, 0.0021191314993003496 + 0.003159922373152566im, -6.854223346899894e-5 - 0.0013600073870876014im, 0.0005504781417408298 - 0.0010319702903617833im, -0.000638331663814698 + 0.0003829682239872169im, -0.0008123297657610053 - 7.479300924255472e-19im, 0.0006383316638146981 + 0.00038296822398721704im, 0.0005504781417408287 + 0.0010319702903617844im, 6.854223346899728e-5 - 0.0013600073870876027im, 0.002119131499300352 - 0.0031599223731525704im, -0.004664968526149503 + 0.0021943099151750262im, -0.04721211730769723 - 0.004770945450253967im, 0.08972258675485481 - 0.06695528255581208im, -0.012100870744564143 + 0.0012228342511181323im, -0.006688914771506646 - 0.0031463348537645332im, 0.0015017766128543161 + 0.002239359579443492im, 9.075057900240338e-5 + 0.0018006632818353637im, 0.0005629201891566652 - 0.001055295157113713im, 0.000809393906503604 - 0.00048559732007107435im, -0.0009226709483414911 - 5.353248226647178e-19im, -0.0008093939065035967 - 0.00048559732007107505im, 0.0005629201891566598 + 0.0010552951571137091im, -9.075057900242963e-5 + 0.0018006632818353605im, 0.0015017766128543322 - 0.0022393595794434713im, 0.0066889147715066925 - 0.003146334853764516im, -0.012100870744564162 - 0.0012228342511181906im, -0.08972258675485477 - 0.06695528255581218im, -0.11567129077318733 + 0.28194824808035207im, 0.026534622612494944 - 0.019801403020302977im, 0.016873799117283726 - 0.0017051538893046274im, -0.0057090523112351774 - 0.0026854265675736178im, -0.0018862169577630245 - 0.002812614226285411im, 0.00011820118411841573 + 0.00234533471828073im, -0.0006589939626650637 + 0.0012354027009572467im, 0.0012603984223292588 - 0.0007561782903660621im, 0.001053540501909276 + 1.2722434867759591e-18im, -0.0012603984223292547 - 0.0007561782903660641im, -0.000658993962665057 - 0.0012354027009572493im, -0.00011820118411842759 + 0.0023453347182807245im, -0.0018862169577630373 + 0.0028126142262853994im, 0.005709052311235185 - 0.0026854265675735917im, 0.016873799117283712 + 0.0017051538893046415im, -0.026534622612494865 - 0.019801403020303063im, -0.11567129077318691 - 0.2819482480803519im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]

weights = initialize_expansion(expansion_order)
rotated_weights = initialize_expansion(expansion_order)
i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            weights[1,1,i_compressed] = real(weights_test[i])
            weights[2,1,i_compressed] = imag(weights_test[i])
            i_compressed += 1
        end
        i += 1
    end
end

Hs_π2 = [1.0]
FastMultipole.update_Hs_π2!(Hs_π2, Val(expansion_order))
ηs_mag = zeros(FastMultipole.length_ηs(expansion_order))
FastMultipole.update_ηs_mag!(ηs_mag, 0, expansion_order)
Ts = zeros(FastMultipole.length_Ts(expansion_order))
θ = 2.5010703409103683
lamb_helmholtz = Val(false)

FastMultipole.rotate_local_y!(rotated_weights, weights, Ts, Hs_π2, ηs_mag, θ, expansion_order, lamb_helmholtz)

i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            @test isapprox(rotated_weights[1,1,i_compressed], real(rotated_weights_test[i]); atol=1e-12)
            @test isapprox(rotated_weights[2,1,i_compressed], imag(rotated_weights_test[i]); atol=1e-12)
            i_compressed += 1
        end
        i += 1
    end
end

end

@testset "multipole back rotation about y axis" begin

expansion_order = 10

weights_test = ComplexF64[0.12778297701763344 + 4.529689653984122e-19im, 0.01988565068340494 + 0.011071240208005997im, 0.005109803172606758 + 3.2526065174565133e-19im, -0.019885650683404945 + 0.011071240208006im, 0.006406175925111939 + 0.010337471580447111im, 0.002385570364972926 + 0.0013281548027035902im, -0.0036451747879949242 - 3.049318610115481e-20im, -0.0023855703649729256 + 0.0013281548027035898im, 0.006406175925111935 - 0.010337471580447108im, 0.0005064190184181157 + 0.0108187987474021im, 0.0012808552115572672 + 0.002066881133029694im, -0.0015110027367938065 - 0.0008412434953346443im, -0.00140992377229235 - 7.115076756936123e-20im, 0.0015110027367938065 - 0.0008412434953346439im, 0.0012808552115572695 - 0.002066881133029696im, -0.0005064190184181154 + 0.010818798747402106im, -0.00600979378232354 + 0.012092524633138818im, 0.00014175533778046622 + 0.0030283652269413376im, -0.0007088462454376961 - 0.0011438458938830946im, -0.001058918726541237 - 0.0005895478906568543im, 0.0006985665458948552 - 1.1779382795000135e-19im, 0.001058918726541237 - 0.0005895478906568545im, -0.0007088462454376964 + 0.0011438458938830957im, -0.00014175533778046644 + 0.0030283652269413363im, -0.006009793782323535 - 0.012092524633138793im, -0.017846596319110775 + 0.012250354186902287im, -0.0021628838222466995 + 0.00435201787134357im, -6.711258877263314e-5 - 0.001433749642424643im, -0.000767299139505339 - 0.0012381696520475816im, 0.00037417963078447444 + 0.00020832271843066228im, 0.0010031457155584922 + 1.2180317237904588e-19im, -0.0003741796307844752 + 0.00020832271843066233im, -0.0007672991395053396 + 0.001238169652047583im, 6.711258877263316e-5 - 0.0014337496424246432im, -0.0021628838222466987 - 0.004352017871343578im, 0.017846596319110775 + 0.012250354186902285im, -0.0422254692979453 + 0.0039617607195511755im, -0.007850172482929591 + 0.005388558288009481im, 0.000851017065931367 - 0.0017123618690188128im, -0.00010510135582031117 - 0.0022453119320058495im, 0.0001585337136231433 + 0.0002558216546230435im, 0.0010114739907600583 + 0.0005631332487366796im, -0.00014071294694094805 + 5.1777706484880617e-20im, -0.0010114739907600577 + 0.00056313324873668im, 0.000158533713623143 - 0.0002558216546230434im, 0.00010510135582031068 - 0.002245311932005849im, 0.0008510170659313671 + 0.0017123618690188147im, 0.007850172482929582 + 0.005388558288009473im, -0.042225469297945226 - 0.0039617607195511365im, -0.08988721063334315 - 0.03954501582849908im, -0.0219507296948253 + 0.0020595118239022173im, 0.0024609342549554544 - 0.0016892459109781428im, 0.00188389208320225 - 0.003790649516221961im, 5.746722439507631e-6 + 0.0001227763044802724im, 0.0009006229151328835 + 0.0014533104799389531im, 8.939703828641429e-5 + 4.977129351573298e-5im, -0.0012765669625816212 - 3.0557917426951705e-20im, -8.939703828641551e-5 + 4.9771293515732507e-5im, 0.0009006229151328834 - 0.0014533104799389518im, -5.7467224395056585e-6 + 0.00012277630448027281im, 0.001883892083202249 + 0.0037906495162219546im, -0.0024609342549554553 - 0.001689245910978146im, -0.021950729694825304 - 0.002059511823902216im, 0.08988721063334319 - 0.039545015828499064im, -0.15843120086296467 - 0.20912900046970154im, -0.053916337687050585 - 0.02371993084526941im, 0.0051257565765804244 - 0.00048091195635664084im, 0.007754397654929301 - 0.005322819104358317im, 0.00019415738394774093 - 0.00039067517018100925im, 0.00014354105250680534 + 0.003066505906362175im, 0.00030248360848619154 + 0.0004881087272936323im, -0.0015642563554373414 - 0.0008708921388456051im, -0.0005359500072129925 - 3.8273545140644316e-19im, 0.0015642563554373434 - 0.0008708921388456052im, 0.0003024836084861944 - 0.00048810872729363445im, -0.00014354105250680534 + 0.003066505906362176im, 0.0001941573839477417 + 0.0003906751701810133im, -0.007754397654929301 - 0.005322819104358313im, 0.005125756576580412 + 0.0004809119563566352im, 0.0539163376870506 - 0.023719930845269428im, -0.15843120086296497 + 0.20912900046970165im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]

rotated_weights_test = ComplexF64[0.12778297701763344 + 4.529689653984122e-19im, -0.019885650683404952 + 0.011930431692490973im, 0.0025193744931942307 - 8.673617379884035e-19im, 0.019885650683404945 + 0.011930431692490969im, 0.005942197679130063 - 0.01113971842826999im, -0.0011761989500464842 + 0.0007056626638456422im, -0.004109153033976794 - 1.6263032587282567e-18im, 0.0011761989500464884 + 0.0007056626638456403im, 0.005942197679130065 + 0.011139718428269994im, 0.000576648870009004 + 0.011441803168288111im, 0.0005857830848405143 - 0.001098155763921616im, 0.0018720253662695158 - 0.0011231249662401533im, -0.0007408981349946234 - 3.9810548520952116e-19im, -0.0018720253662695122 - 0.0011231249662401568im, 0.000585783084840505 + 0.0010981557639216147im, -0.0005766488700090121 + 0.011441803168288097im, -0.008106000111679428 - 0.01208718317679199im, 7.958463431428833e-5 + 0.0015791094866532758im, -0.000909227295655526 + 0.0017045101140383627im, 0.000571922541553128 - 0.0003431259518988544im, 0.0011301272553897019 + 1.0842021724855044e-19im, -0.0005719225415531302 - 0.00034312595189885597im, -0.0009092272956555333 - 0.0017045101140383651im, -7.958463431427204e-5 + 0.001579109486653281im, -0.008106000111679421 + 0.012087183176792008im, 0.021509795286519688 + 0.010117786891757258im, -0.0014383641626404663 - 0.0021448027126433067im, -0.00012038964667837018 - 0.0023887582016687667im, -0.00039558101178137437 + 0.0007415877649552499im, -0.0008342506452508623 + 0.0005005101661127942im, 0.0005955632051110156 + 6.166399856011306e-19im, 0.0008342506452508643 + 0.0005005101661127966im, -0.0003955810117813741 - 0.0007415877649552507im, 0.00012038964667837174 - 0.002388758201668767im, -0.001438364162640469 + 0.0021448027126433006im, -0.021509795286519705 + 0.010117786891757253im, -0.047212117307697185 + 0.00477094545025394im, 0.004664968526149511 + 0.0021943099151750245im, 0.0021191314993003496 + 0.003159922373152566im, -6.854223346899894e-5 - 0.0013600073870876014im, 0.0005504781417408298 - 0.0010319702903617833im, -0.000638331663814698 + 0.0003829682239872169im, -0.0008123297657610053 - 7.479300924255472e-19im, 0.0006383316638146981 + 0.00038296822398721704im, 0.0005504781417408287 + 0.0010319702903617844im, 6.854223346899728e-5 - 0.0013600073870876027im, 0.002119131499300352 - 0.0031599223731525704im, -0.004664968526149503 + 0.0021943099151750262im, -0.04721211730769723 - 0.004770945450253967im, 0.08972258675485481 - 0.06695528255581208im, -0.012100870744564143 + 0.0012228342511181323im, -0.006688914771506646 - 0.0031463348537645332im, 0.0015017766128543161 + 0.002239359579443492im, 9.075057900240338e-5 + 0.0018006632818353637im, 0.0005629201891566652 - 0.001055295157113713im, 0.000809393906503604 - 0.00048559732007107435im, -0.0009226709483414911 - 5.353248226647178e-19im, -0.0008093939065035967 - 0.00048559732007107505im, 0.0005629201891566598 + 0.0010552951571137091im, -9.075057900242963e-5 + 0.0018006632818353605im, 0.0015017766128543322 - 0.0022393595794434713im, 0.0066889147715066925 - 0.003146334853764516im, -0.012100870744564162 - 0.0012228342511181906im, -0.08972258675485477 - 0.06695528255581218im, -0.11567129077318733 + 0.28194824808035207im, 0.026534622612494944 - 0.019801403020302977im, 0.016873799117283726 - 0.0017051538893046274im, -0.0057090523112351774 - 0.0026854265675736178im, -0.0018862169577630245 - 0.002812614226285411im, 0.00011820118411841573 + 0.00234533471828073im, -0.0006589939626650637 + 0.0012354027009572467im, 0.0012603984223292588 - 0.0007561782903660621im, 0.001053540501909276 + 1.2722434867759591e-18im, -0.0012603984223292547 - 0.0007561782903660641im, -0.000658993962665057 - 0.0012354027009572493im, -0.00011820118411842759 + 0.0023453347182807245im, -0.0018862169577630373 + 0.0028126142262853994im, 0.005709052311235185 - 0.0026854265675735917im, 0.016873799117283712 + 0.0017051538893046415im, -0.026534622612494865 - 0.019801403020303063im, -0.11567129077318691 - 0.2819482480803519im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]
θ = 2.5010703409103683
rotated_weights = initialize_expansion(expansion_order)
back_rotated_weights = initialize_expansion(expansion_order)
i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            rotated_weights[1,1,i_compressed] = real(rotated_weights_test[i])
            rotated_weights[2,1,i_compressed] = imag(rotated_weights_test[i])
            i_compressed += 1
        end
        i += 1
    end
end

Hs_π2 = [1.0]
FastMultipole.update_Hs_π2!(Hs_π2, Val(expansion_order))
ηs_mag = zeros(FastMultipole.length_ηs(expansion_order))
FastMultipole.update_ηs_mag!(ηs_mag, 0, expansion_order)
Ts = zeros(FastMultipole.length_Ts(expansion_order))

FastMultipole.update_Ts!(Ts, Hs_π2, θ, expansion_order)
lamb_helmholtz = Val(false)

FastMultipole.back_rotate_local_y!(back_rotated_weights, rotated_weights, Ts, Hs_π2, ηs_mag, expansion_order, lamb_helmholtz)

i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            @test isapprox(back_rotated_weights[1,1,i_compressed], real(weights_test[i]); atol=1e-12)
            @test isapprox(back_rotated_weights[2,1,i_compressed], imag(weights_test[i]); atol=1e-12)
            i_compressed += 1
        end
        i += 1
    end
end

end


@testset "local rotation about z axis" begin

expansion_order = 10

weights_test = ComplexF64[0.12778297701763344 + 4.529689653984122e-19im, 0.01988565068340494 + 0.011071240208005997im, 0.005109803172606758 + 3.2526065174565133e-19im, -0.019885650683404945 + 0.011071240208006im, 0.006406175925111939 + 0.010337471580447111im, 0.002385570364972926 + 0.0013281548027035902im, -0.0036451747879949242 - 3.049318610115481e-20im, -0.0023855703649729256 + 0.0013281548027035898im, 0.006406175925111935 - 0.010337471580447108im, 0.0005064190184181157 + 0.0108187987474021im, 0.0012808552115572672 + 0.002066881133029694im, -0.0015110027367938065 - 0.0008412434953346443im, -0.00140992377229235 - 7.115076756936123e-20im, 0.0015110027367938065 - 0.0008412434953346439im, 0.0012808552115572695 - 0.002066881133029696im, -0.0005064190184181154 + 0.010818798747402106im, -0.00600979378232354 + 0.012092524633138818im, 0.00014175533778046622 + 0.0030283652269413376im, -0.0007088462454376961 - 0.0011438458938830946im, -0.001058918726541237 - 0.0005895478906568543im, 0.0006985665458948552 - 1.1779382795000135e-19im, 0.001058918726541237 - 0.0005895478906568545im, -0.0007088462454376964 + 0.0011438458938830957im, -0.00014175533778046644 + 0.0030283652269413363im, -0.006009793782323535 - 0.012092524633138793im, -0.017846596319110775 + 0.012250354186902287im, -0.0021628838222466995 + 0.00435201787134357im, -6.711258877263314e-5 - 0.001433749642424643im, -0.000767299139505339 - 0.0012381696520475816im, 0.00037417963078447444 + 0.00020832271843066228im, 0.0010031457155584922 + 1.2180317237904588e-19im, -0.0003741796307844752 + 0.00020832271843066233im, -0.0007672991395053396 + 0.001238169652047583im, 6.711258877263316e-5 - 0.0014337496424246432im, -0.0021628838222466987 - 0.004352017871343578im, 0.017846596319110775 + 0.012250354186902285im, -0.0422254692979453 + 0.0039617607195511755im, -0.007850172482929591 + 0.005388558288009481im, 0.000851017065931367 - 0.0017123618690188128im, -0.00010510135582031117 - 0.0022453119320058495im, 0.0001585337136231433 + 0.0002558216546230435im, 0.0010114739907600583 + 0.0005631332487366796im, -0.00014071294694094805 + 5.1777706484880617e-20im, -0.0010114739907600577 + 0.00056313324873668im, 0.000158533713623143 - 0.0002558216546230434im, 0.00010510135582031068 - 0.002245311932005849im, 0.0008510170659313671 + 0.0017123618690188147im, 0.007850172482929582 + 0.005388558288009473im, -0.042225469297945226 - 0.0039617607195511365im, -0.08988721063334315 - 0.03954501582849908im, -0.0219507296948253 + 0.0020595118239022173im, 0.0024609342549554544 - 0.0016892459109781428im, 0.00188389208320225 - 0.003790649516221961im, 5.746722439507631e-6 + 0.0001227763044802724im, 0.0009006229151328835 + 0.0014533104799389531im, 8.939703828641429e-5 + 4.977129351573298e-5im, -0.0012765669625816212 - 3.0557917426951705e-20im, -8.939703828641551e-5 + 4.9771293515732507e-5im, 0.0009006229151328834 - 0.0014533104799389518im, -5.7467224395056585e-6 + 0.00012277630448027281im, 0.001883892083202249 + 0.0037906495162219546im, -0.0024609342549554553 - 0.001689245910978146im, -0.021950729694825304 - 0.002059511823902216im, 0.08988721063334319 - 0.039545015828499064im, -0.15843120086296467 - 0.20912900046970154im, -0.053916337687050585 - 0.02371993084526941im, 0.0051257565765804244 - 0.00048091195635664084im, 0.007754397654929301 - 0.005322819104358317im, 0.00019415738394774093 - 0.00039067517018100925im, 0.00014354105250680534 + 0.003066505906362175im, 0.00030248360848619154 + 0.0004881087272936323im, -0.0015642563554373414 - 0.0008708921388456051im, -0.0005359500072129925 - 3.8273545140644316e-19im, 0.0015642563554373434 - 0.0008708921388456052im, 0.0003024836084861944 - 0.00048810872729363445im, -0.00014354105250680534 + 0.003066505906362176im, 0.0001941573839477417 + 0.0003906751701810133im, -0.007754397654929301 - 0.005322819104358313im, 0.005125756576580412 + 0.0004809119563566352im, 0.0539163376870506 - 0.023719930845269428im, -0.15843120086296497 + 0.20912900046970165im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]

rotated_weights_test = ComplexF64[0.12778297701763344 + 4.529689653984122e-19im, 0.0010092849391504064 - 0.022737475822029497im, 0.005109803172606759 + 2.6345977323774246e-19im, -0.001009284939150408 - 0.022737475822029504im, -0.012113682819424848 - 0.001077542208178714im, 0.00012107826915753012 - 0.002727687885172987im, -0.0036451747879949225 - 2.0884443116411584e-19im, -0.00012107826915753023 - 0.0027276878851729904im, -0.01211368281942484 + 0.0010775422081787148im, -0.001437075120602536 + 0.010734881539018052im, -0.002422018033358114 - 0.00021544451057200226im, -7.669008974728186e-5 + 0.0017276974617032332im, -0.0014099237722923507 - 6.082497616021239e-22im, 7.669008974728136e-5 + 0.001727697461703233im, -0.002422018033358121 + 0.00021544451057200212im, 0.0014370751206025387 + 0.010734881539018061im, 0.013291565906863893 + 0.0023834951337517313im, -0.00040226162921274246 + 0.0030048753892965075im, 0.001340384462369096 + 0.0001192305399797003im, -5.374481276139226e-5 + 0.0012107795339775579im, 0.000698566545894857 - 3.984199126579273e-20im, 5.374481276139265e-5 + 0.001210779533977557im, 0.0013403844623690972 - 0.00011923053997969999im, 0.00040226162921274257 + 0.0030048753892965153im, 0.013291565906863843 - 0.0023834951337517317im, 0.004761876520031311 - 0.02111626647610385im, 0.004783544626718908 + 0.0008578034653806285im, 0.00019044687637189892 - 0.0014226285966494378im, 0.001450915205341271 + 0.0001290624796242772im, 1.8991285821432276e-5 - 0.00042784118802564566im, 0.0010031457155584942 - 1.954016969617584e-21im, -1.8991285821431567e-5 - 0.0004278411880256467im, 0.0014509152053412734 - 0.00012906247962427787im, -0.00019044687637189838 - 0.0014226285966494373im, 0.0047835446267189274 - 0.0008578034653806262im, -0.004761876520031316 - 0.021116266476103845im, -0.0409175790361589 - 0.011155157159376799im, 0.0020946028123290826 - 0.009288401772834886im, -0.0018821521727188477 - 0.00033751505996884324im, 0.00029824754735020755 - 0.002227895950780164im, -0.0002997775518723225 - 2.6666021875311182e-5im, 5.1336769663707846e-5 - 0.0011565306852380907im, -0.00014071294694094949 - 2.0874864488680092e-19im, -5.133676966370887e-5 - 0.0011565306852380918im, -0.00029977755187232213 + 2.6666021875310986e-5im, -0.0002982475473502087 - 0.002227895950780164im, -0.0018821521727188468 + 0.00033751505996883945im, -0.002094602812329096 - 0.009288401772834956im, -0.040917579036158634 + 0.011155157159376776im, -0.030005475240813616 + 0.09350502857008425im, -0.02127083115637001 - 0.005798953785406065im, -0.0006566340595252756 + 0.0029118002793531565im, -0.0041665133188697025 - 0.0007471545353320185im, -1.6308865737598964e-5 + 0.0001218239166132097im, -0.0017030221330308851 - 0.00015148795585706639im, 4.537227332594989e-6 - 0.00010221754096408572im, -0.0012765669625816158 - 5.309613771659628e-19im, -4.537227332593597e-6 - 0.00010221754096408799im, -0.001703022133030884 + 0.00015148795585706546im, 1.6308865737602196e-5 + 0.00012182391661320668im, -0.004166513318869686 + 0.0007471545353320157im, 0.0006566340595252627 + 0.002911800279353116im, -0.021270831156369973 + 0.0057989537854060726im, 0.030005475240813644 + 0.09350502857008447im, 0.24601693922016582 + 0.09116495961212132im, -0.017997903579605047 + 0.05608638030420203im, 0.004966989164316874 + 0.0013541327238064586im, -0.0020690458259826554 + 0.009175082319983631im, -0.00042941223087913954 - 7.700204093915164e-5im, -0.0004073275303769202 + 0.003042720294490706im, -0.0005719771469266252 - 5.087834958722589e-5im, -7.939290041279043e-5 + 0.0017885882227033506im, -0.0005359500072129982 - 1.3629063465193172e-19im, 7.939290041278933e-5 + 0.0017885882227033519im, -0.0005719771469266332 + 5.087834958722586e-5im, 0.0004073275303769216 + 0.0030427202944907127im, -0.00042941223087915016 + 7.700204093915103e-5im, 0.002069045825982665 + 0.00917508231998365im, 0.004966989164316808 - 0.001354132723806454im, 0.017997903579605165 + 0.05608638030420232im, 0.24601693922016518 - 0.09116495961212095im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]

weights = initialize_expansion(expansion_order)
rotated_weights = initialize_expansion(expansion_order)
i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            weights[1,1,i_compressed] = real(weights_test[i])
            weights[2,1,i_compressed] = imag(weights_test[i])
            i_compressed += 1
        end
        i += 1
    end
end

ϕ = 2.0344439357957027
eimϕs = zeros(2, expansion_order+1)
lamb_helmholtz = Val(false)
FastMultipole.rotate_z!(rotated_weights, weights, eimϕs, ϕ, expansion_order, lamb_helmholtz)

i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            @test isapprox(rotated_weights[1,1,i_compressed], real(rotated_weights_test[i]); atol=1e-12)
            @test isapprox(rotated_weights[2,1,i_compressed], imag(rotated_weights_test[i]); atol=1e-12)
            i_compressed += 1
        end
        i += 1
    end
end

end

@testset "local back rotation about z axis" begin

expansion_order = 10

weights_test = ComplexF64[0.12778297701763344 + 4.529689653984122e-19im, 0.01988565068340494 + 0.011071240208005997im, 0.005109803172606758 + 3.2526065174565133e-19im, -0.019885650683404945 + 0.011071240208006im, 0.006406175925111939 + 0.010337471580447111im, 0.002385570364972926 + 0.0013281548027035902im, -0.0036451747879949242 - 3.049318610115481e-20im, -0.0023855703649729256 + 0.0013281548027035898im, 0.006406175925111935 - 0.010337471580447108im, 0.0005064190184181157 + 0.0108187987474021im, 0.0012808552115572672 + 0.002066881133029694im, -0.0015110027367938065 - 0.0008412434953346443im, -0.00140992377229235 - 7.115076756936123e-20im, 0.0015110027367938065 - 0.0008412434953346439im, 0.0012808552115572695 - 0.002066881133029696im, -0.0005064190184181154 + 0.010818798747402106im, -0.00600979378232354 + 0.012092524633138818im, 0.00014175533778046622 + 0.0030283652269413376im, -0.0007088462454376961 - 0.0011438458938830946im, -0.001058918726541237 - 0.0005895478906568543im, 0.0006985665458948552 - 1.1779382795000135e-19im, 0.001058918726541237 - 0.0005895478906568545im, -0.0007088462454376964 + 0.0011438458938830957im, -0.00014175533778046644 + 0.0030283652269413363im, -0.006009793782323535 - 0.012092524633138793im, -0.017846596319110775 + 0.012250354186902287im, -0.0021628838222466995 + 0.00435201787134357im, -6.711258877263314e-5 - 0.001433749642424643im, -0.000767299139505339 - 0.0012381696520475816im, 0.00037417963078447444 + 0.00020832271843066228im, 0.0010031457155584922 + 1.2180317237904588e-19im, -0.0003741796307844752 + 0.00020832271843066233im, -0.0007672991395053396 + 0.001238169652047583im, 6.711258877263316e-5 - 0.0014337496424246432im, -0.0021628838222466987 - 0.004352017871343578im, 0.017846596319110775 + 0.012250354186902285im, -0.0422254692979453 + 0.0039617607195511755im, -0.007850172482929591 + 0.005388558288009481im, 0.000851017065931367 - 0.0017123618690188128im, -0.00010510135582031117 - 0.0022453119320058495im, 0.0001585337136231433 + 0.0002558216546230435im, 0.0010114739907600583 + 0.0005631332487366796im, -0.00014071294694094805 + 5.1777706484880617e-20im, -0.0010114739907600577 + 0.00056313324873668im, 0.000158533713623143 - 0.0002558216546230434im, 0.00010510135582031068 - 0.002245311932005849im, 0.0008510170659313671 + 0.0017123618690188147im, 0.007850172482929582 + 0.005388558288009473im, -0.042225469297945226 - 0.0039617607195511365im, -0.08988721063334315 - 0.03954501582849908im, -0.0219507296948253 + 0.0020595118239022173im, 0.0024609342549554544 - 0.0016892459109781428im, 0.00188389208320225 - 0.003790649516221961im, 5.746722439507631e-6 + 0.0001227763044802724im, 0.0009006229151328835 + 0.0014533104799389531im, 8.939703828641429e-5 + 4.977129351573298e-5im, -0.0012765669625816212 - 3.0557917426951705e-20im, -8.939703828641551e-5 + 4.9771293515732507e-5im, 0.0009006229151328834 - 0.0014533104799389518im, -5.7467224395056585e-6 + 0.00012277630448027281im, 0.001883892083202249 + 0.0037906495162219546im, -0.0024609342549554553 - 0.001689245910978146im, -0.021950729694825304 - 0.002059511823902216im, 0.08988721063334319 - 0.039545015828499064im, -0.15843120086296467 - 0.20912900046970154im, -0.053916337687050585 - 0.02371993084526941im, 0.0051257565765804244 - 0.00048091195635664084im, 0.007754397654929301 - 0.005322819104358317im, 0.00019415738394774093 - 0.00039067517018100925im, 0.00014354105250680534 + 0.003066505906362175im, 0.00030248360848619154 + 0.0004881087272936323im, -0.0015642563554373414 - 0.0008708921388456051im, -0.0005359500072129925 - 3.8273545140644316e-19im, 0.0015642563554373434 - 0.0008708921388456052im, 0.0003024836084861944 - 0.00048810872729363445im, -0.00014354105250680534 + 0.003066505906362176im, 0.0001941573839477417 + 0.0003906751701810133im, -0.007754397654929301 - 0.005322819104358313im, 0.005125756576580412 + 0.0004809119563566352im, 0.0539163376870506 - 0.023719930845269428im, -0.15843120086296497 + 0.20912900046970165im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]

rotated_weights_test = ComplexF64[0.12778297701763344 + 4.529689653984122e-19im, 0.0010092849391504064 - 0.022737475822029497im, 0.005109803172606759 + 2.6345977323774246e-19im, -0.001009284939150408 - 0.022737475822029504im, -0.012113682819424848 - 0.001077542208178714im, 0.00012107826915753012 - 0.002727687885172987im, -0.0036451747879949225 - 2.0884443116411584e-19im, -0.00012107826915753023 - 0.0027276878851729904im, -0.01211368281942484 + 0.0010775422081787148im, -0.001437075120602536 + 0.010734881539018052im, -0.002422018033358114 - 0.00021544451057200226im, -7.669008974728186e-5 + 0.0017276974617032332im, -0.0014099237722923507 - 6.082497616021239e-22im, 7.669008974728136e-5 + 0.001727697461703233im, -0.002422018033358121 + 0.00021544451057200212im, 0.0014370751206025387 + 0.010734881539018061im, 0.013291565906863893 + 0.0023834951337517313im, -0.00040226162921274246 + 0.0030048753892965075im, 0.001340384462369096 + 0.0001192305399797003im, -5.374481276139226e-5 + 0.0012107795339775579im, 0.000698566545894857 - 3.984199126579273e-20im, 5.374481276139265e-5 + 0.001210779533977557im, 0.0013403844623690972 - 0.00011923053997969999im, 0.00040226162921274257 + 0.0030048753892965153im, 0.013291565906863843 - 0.0023834951337517317im, 0.004761876520031311 - 0.02111626647610385im, 0.004783544626718908 + 0.0008578034653806285im, 0.00019044687637189892 - 0.0014226285966494378im, 0.001450915205341271 + 0.0001290624796242772im, 1.8991285821432276e-5 - 0.00042784118802564566im, 0.0010031457155584942 - 1.954016969617584e-21im, -1.8991285821431567e-5 - 0.0004278411880256467im, 0.0014509152053412734 - 0.00012906247962427787im, -0.00019044687637189838 - 0.0014226285966494373im, 0.0047835446267189274 - 0.0008578034653806262im, -0.004761876520031316 - 0.021116266476103845im, -0.0409175790361589 - 0.011155157159376799im, 0.0020946028123290826 - 0.009288401772834886im, -0.0018821521727188477 - 0.00033751505996884324im, 0.00029824754735020755 - 0.002227895950780164im, -0.0002997775518723225 - 2.6666021875311182e-5im, 5.1336769663707846e-5 - 0.0011565306852380907im, -0.00014071294694094949 - 2.0874864488680092e-19im, -5.133676966370887e-5 - 0.0011565306852380918im, -0.00029977755187232213 + 2.6666021875310986e-5im, -0.0002982475473502087 - 0.002227895950780164im, -0.0018821521727188468 + 0.00033751505996883945im, -0.002094602812329096 - 0.009288401772834956im, -0.040917579036158634 + 0.011155157159376776im, -0.030005475240813616 + 0.09350502857008425im, -0.02127083115637001 - 0.005798953785406065im, -0.0006566340595252756 + 0.0029118002793531565im, -0.0041665133188697025 - 0.0007471545353320185im, -1.6308865737598964e-5 + 0.0001218239166132097im, -0.0017030221330308851 - 0.00015148795585706639im, 4.537227332594989e-6 - 0.00010221754096408572im, -0.0012765669625816158 - 5.309613771659628e-19im, -4.537227332593597e-6 - 0.00010221754096408799im, -0.001703022133030884 + 0.00015148795585706546im, 1.6308865737602196e-5 + 0.00012182391661320668im, -0.004166513318869686 + 0.0007471545353320157im, 0.0006566340595252627 + 0.002911800279353116im, -0.021270831156369973 + 0.0057989537854060726im, 0.030005475240813644 + 0.09350502857008447im, 0.24601693922016582 + 0.09116495961212132im, -0.017997903579605047 + 0.05608638030420203im, 0.004966989164316874 + 0.0013541327238064586im, -0.0020690458259826554 + 0.009175082319983631im, -0.00042941223087913954 - 7.700204093915164e-5im, -0.0004073275303769202 + 0.003042720294490706im, -0.0005719771469266252 - 5.087834958722589e-5im, -7.939290041279043e-5 + 0.0017885882227033506im, -0.0005359500072129982 - 1.3629063465193172e-19im, 7.939290041278933e-5 + 0.0017885882227033519im, -0.0005719771469266332 + 5.087834958722586e-5im, 0.0004073275303769216 + 0.0030427202944907127im, -0.00042941223087915016 + 7.700204093915103e-5im, 0.002069045825982665 + 0.00917508231998365im, 0.004966989164316808 - 0.001354132723806454im, 0.017997903579605165 + 0.05608638030420232im, 0.24601693922016518 - 0.09116495961212095im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]

weights = initialize_expansion(expansion_order)
back_rotated_weights = initialize_expansion(expansion_order)
i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            weights[1,1,i_compressed] = real(rotated_weights_test[i])
            weights[2,1,i_compressed] = imag(rotated_weights_test[i])
            i_compressed += 1
        end
        i += 1
    end
end

ϕ = 2.0344439357957027
eimϕs = zeros(2, expansion_order+1)
FastMultipole.update_eimϕs!(eimϕs, ϕ, expansion_order)
lamb_helmholtz = Val(false)
FastMultipole.back_rotate_z!(back_rotated_weights, weights, eimϕs, expansion_order, lamb_helmholtz)

i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            @test isapprox(back_rotated_weights[1,1,i_compressed], real(weights_test[i]); atol=1e-12)
            @test isapprox(back_rotated_weights[2,1,i_compressed], imag(weights_test[i]); atol=1e-12)
            i_compressed += 1
        end
        i += 1
    end
end

end

