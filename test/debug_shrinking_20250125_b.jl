using FastMultipole
using FastMultipole.StaticArrays
include("gravitational.jl")

target_center = SVector{3}([0.060591180190751714, 0.43760692702617704, 0.5627470303723449])
source_center = SVector{3}([0.3760373945914077, 0.87542676469004, 0.8757716980619457])
target_radius = 0.08635593669678411
source_radius = 0.2057555427028464
target_box = SVector{3}([0.04762615502966494, 0.05984411520163352, 0.051935278296515563])
source_box = SVector{3}([0.12569155926176567, 0.12521286906507578, 0.125561862391109])

source_x = SVector{3, Float64}[[0.2773335119356213, 0.8221015903723444, 0.7917669325894262], [0.26515468100638284, 0.7980885432612075, 0.7533378124311677], [0.31231888303947386, 0.7518969453945542, 0.7731701250783884], [0.2884874084543467, 0.8299861577612931, 0.7748440998882511], [0.2953052121867171, 0.7511038919509803, 0.8158163528006334], [0.3069578415496491, 0.7574609609002577, 0.8533696308580536], [0.30683704736628115, 0.8073715365706432, 0.8399165202621973], [0.2689565752884058, 0.780740554413969, 0.8336794935457333], [0.2888828152142707, 0.8199626653225527, 0.8004944608420722], [0.3492667434254537, 0.7561524898745269, 0.7774376401878271], [0.267487823641379, 0.8315048388114734, 0.7830325916793164], [0.3232685581773651, 0.8741930522570591, 0.8573095509685921], [0.25603185154391717, 0.8078958064660088, 0.8115839907948948], [0.29244308538149033, 0.7564369647647717, 0.7977093106784691], [0.27751745769960057, 0.8232921247285407, 0.8393789642685677], [0.3313356131386821, 0.7864250373544556, 0.8161368848050903], [0.30762983582260195, 0.7836859281208933, 0.857036963459944], [0.33044505076935204, 0.8210178126235977, 0.8269517428461858], [0.34224395677999964, 0.7627940334377644, 0.783648609888645], [0.30823277044416775, 0.8079867288443834, 0.8611176421679746], [0.3635450970934869, 0.8188276438004587, 0.853055356146816], [0.3199727985164199, 0.823733644489293, 0.827465693298103], [0.4343310219379892, 0.7880654251854676, 0.8519001479325996], [0.4697631982887037, 0.7508726874549099, 0.7555324248546713], [0.4036520815075074, 0.8287166087713398, 0.8469863476470287], [0.44336662145814154, 0.760275266601879, 0.856889587863476], [0.42434872807927293, 0.8583058553636628, 0.760993149872666], [0.4759046304498208, 0.7787296091567139, 0.839120321260662], [0.40405784285808954, 0.7824828380335254, 0.7577935131180493], [0.38175910968260485, 0.802415679294129, 0.7850721227292635], [0.4106038005153553, 0.8588078584817236, 0.7957117450698487], [0.3945746101013605, 0.8522384899110422, 0.8131057871903583], [0.395703611804362, 0.7833731015460873, 0.8416045314610769], [0.4042251299927302, 0.8484505785459527, 0.772173527990528], [0.44746444881032377, 0.8058967815657908, 0.7957124847400093], [0.41065832646206646, 0.7647608105461567, 0.7725468200172028], [0.4180787230820179, 0.7878321049875872, 0.8575397354838702], [0.3947003920883202, 0.7611695067724034, 0.7940244018827288], [0.41181890456879755, 0.7930553108360234, 0.8000347837969752], [0.44431556521020354, 0.8363754567926, 0.8088491293171013], [0.4071423721786195, 0.759752084641944, 0.7944327145391752], [0.42063296620363033, 0.8237443016503758, 0.75418172093292], [0.3948535444975132, 0.8468034126733694, 0.7788438995139442], [0.35433620801965227, 0.9934961880814277, 0.7806455877680519], [0.3380793876476115, 0.977660605908621, 0.8432856112514256], [0.30810652026854735, 0.9865574066165643, 0.8674023944706201], [0.35327128827129894, 0.9517821499359771, 0.7931952050163711], [0.3409366501931025, 0.9344449831724838, 0.8722331316190045], [0.3453544544212077, 0.9642921282204479, 0.7845193592258844], [0.26048377113978516, 0.9449403854158436, 0.7993469251746157], [0.2563634446966099, 0.9796095704155597, 0.8388257412054192], [0.32110751899846757, 0.9399480471762675, 0.8065805972499515], [0.3365937591305781, 0.9218025434493249, 0.8410150382082489], [0.36485931420867623, 0.9038545253643686, 0.8062445285347161], [0.28273266000746633, 0.9051699437886623, 0.7718168679235433], [0.3458071209569141, 0.9283049188329046, 0.7665481994192623], [0.3521058662999771, 0.9623242384171391, 0.8361279960788772], [0.3495089471189561, 0.9623397203881974, 0.7979504792666321], [0.2523302053830405, 0.9762202074354296, 0.8436758207524683], [0.3043226955400844, 0.8962293748008298, 0.7528300287705199], [0.35400632627493267, 0.8839639993224575, 0.7680594547833598], [0.28267335325111176, 0.9862915433793604, 0.7897607804657927], [0.31036106420974996, 0.918258193513459, 0.8425379491702112], [0.3234896795323612, 0.9934130223857919, 0.8109353280905852], [0.2628821363944689, 0.8860764383305058, 0.7509537112483577], [0.478591772112811, 0.934821532887626, 0.7773902939887243], [0.4802144061266107, 0.9918732985132225, 0.8746464987172498], [0.456641335572033, 0.9708843086525601, 0.8704660814595564], [0.4730914478542406, 0.8779693418712573, 0.8217031282127322], [0.41788512453806614, 0.9097118850592985, 0.8596073359074691], [0.44080758872587245, 0.8823488658875563, 0.863431703382903], [0.4376970116390084, 0.9960674786140993, 0.8162325055109811], [0.4679934258918539, 0.8915527173096213, 0.8044348320434346], [0.37576175012444935, 0.9962905063208742, 0.8613660136157993], [0.4446369002106103, 0.9520319815217361, 0.7785129936342783], [0.43968997179146396, 0.9799576957291792, 0.8462127204119477], [0.4700388363792427, 0.9055850025797288, 0.7937541260161811], [0.49330129084231333, 0.9985686282671566, 0.8317871520346489], [0.3894388172862425, 0.9219580910710651, 0.75398676523518], [0.40725867003000904, 0.8956576158386291, 0.7521292260632402], [0.4214031357412841, 0.9941264545153802, 0.7920697147368068], [0.4457540162560918, 0.9354288542345511, 0.8632602140891399], [0.38422833713589577, 0.9814759784113775, 0.844498384004083], [0.3598757547321867, 0.7937945603717901, 0.8929036427234851], [0.25589685305770626, 0.753634377306729, 0.9288573040906127], [0.2744071556244583, 0.7721990244245555, 0.8971939314546166], [0.36409783817355, 0.7811649201813834, 0.9004093179506469], [0.2816977188351154, 0.8434686406669355, 0.8887544238571673], [0.2758973470171622, 0.8622587832423624, 0.8919450237313561], [0.37050292765691595, 0.815076454189559, 0.951983506300351], [0.3580133035072801, 0.8052105061090113, 0.9045853510586225], [0.3195340215040754, 0.8347229499791464, 0.9103655110768929], [0.3629023319647392, 0.8611145965669288, 0.9588852882681467], [0.2655307150185221, 0.8155708922999201, 0.8865282632616597], [0.3535315677265449, 0.8196118824057061, 0.8926623840060508], [0.3208810039940253, 0.8245627056937405, 0.9298497240855295], [0.2617394864698369, 0.86988453936525, 0.9211051721099771], [0.25261264305417985, 0.8394070865018085, 0.9932959847948716], [0.3902198880448281, 0.8343469875192886, 0.9374486149617371], [0.4904570900632659, 0.830743926445836, 0.9029894816476338], [0.4499177016173641, 0.7590271560842403, 0.9762369186571003], [0.4716502871999293, 0.8003976604255544, 0.9547316073774351], [0.3794308746639088, 0.8544070094136139, 0.9131669098632377], [0.3955249429714741, 0.8102605271351631, 0.9936977447967917], [0.4806295502326221, 0.7981164617264354, 0.8896273482787456], [0.4178032028911767, 0.7795153000746728, 0.8846751225162699], [0.44092139676998043, 0.7555831745223944, 0.9378077242525251], [0.3924515451147512, 0.7715065228828496, 0.904101052096699], [0.4908469509610712, 0.8268364072549318, 0.9545962103540243], [0.37599267735879105, 0.781702586765096, 0.906109526979221], [0.4734477753915982, 0.8676856293913461, 0.8904822433016486], [0.4276713260795516, 0.7939796127731512, 0.965507868915782], [0.4568214583570033, 0.7864157368034951, 0.9242528405750235], [0.49891470283816686, 0.8540813318142779, 0.9059346544402112], [0.4663853069541445, 0.8126786990944276, 0.8865179893462009], [0.4232133813043403, 0.7955558888912162, 0.9853447289329492], [0.42235844126883015, 0.802409435983359, 0.9999539058675633], [0.26959733915762063, 0.9828582020005828, 0.9449522900646949], [0.2553193732894232, 0.9596976122318102, 0.8773780357110064], [0.3298890834111544, 0.968823638231117, 0.8923754515634132], [0.3173503159533517, 0.9190960258633677, 0.8812706335992267], [0.2914808684188025, 0.9477568536991202, 0.8874101413502509], [0.34318257146517617, 0.9788202589582624, 0.9204179576510455], [0.346227985712355, 0.903689463487003, 0.9143724560324825], [0.25107443576418165, 0.9858852790912191, 0.9554100004729292], [0.2609070078173681, 0.9868554265286107, 0.9534039845514037], [0.33395458017392465, 0.9632622840139331, 0.9640622412327275], [0.36082932091687725, 0.8806926204452491, 0.9087636122641123], [0.3186660946433829, 0.9116266962954578, 0.9284147301620208], [0.30108471539806403, 0.9714496135733443, 0.8975093761544488], [0.2894128187544881, 0.9119822070662047, 0.9355136608212598], [0.2637244273575129, 0.9090809905116944, 0.8796593105224612], [0.26779100106035103, 0.964347189028247, 0.9619393622896908], [0.42628252251746646, 0.9439493664581142, 0.9549774171966868], [0.49198534011475514, 0.9397029311273518, 0.9773661734020034], [0.39111429063793, 0.9174502902219013, 0.9117817373343412], [0.40724403686415167, 0.9905140456418753, 0.8798840222130915], [0.40896502570111326, 0.9027517390221972, 0.8853762284077484], [0.4736048102434852, 0.9448934714163207, 0.9785979812093357], [0.47124136366061475, 0.9864699012029406, 0.9425746315998056], [0.4819769397167689, 0.900709408891708, 0.9472734092106644], [0.412593226983483, 0.9152015805735997, 0.9957838908937751], [0.43547346000603115, 0.9968676505219229, 0.9041762381620438], [0.4867026020011236, 0.9090577312806132, 0.9918361024258266], [0.4786499280652122, 0.9944466888050129, 0.9439473265915403], [0.37610026948287856, 0.8934071523057122, 0.9120665778623765], [0.42548579993741675, 0.8881649141607391, 0.9934177299786405], [0.42830987629714345, 0.8914191868963607, 0.9413109232127763], [0.4613447351366531, 0.9716176440188046, 0.9209686410372614], [0.42905418578049914, 0.9345303234901576, 0.9371281302550423], [0.3796065496055747, 0.8924493916071717, 0.9508714462511538], [0.41855754607449924, 0.952084135102994, 0.991424704950805], [0.4996901481742104, 0.9956571764857078, 0.9069404956216008], [0.4998940682714198, 0.9497448794932803, 0.9298586318654968], [0.4226206007514396, 0.8983615442294094, 0.9098512116243557], [0.37567615001895704, 0.9913690546525841, 0.8866727294915925], [0.43400058094765825, 0.9411908872749188, 0.9220027826372394], [0.4507043551074662, 0.9588744666049696, 0.9288040434756449], [0.4221307492018629, 0.9319339158792025, 0.8888163648198448], [0.43483622676903855, 0.9154499586051006, 0.9465247848752457], [0.39865626673936994, 0.9348603592681495, 0.930628002401493]]
source_m = [0.7176539530929215, 0.18658549921957346, 0.7151122661027451, 0.4744597370100886, 0.7330259531068963, 0.9712008022840743, 0.503237097461472, 0.8965865407557394, 0.853863305505482, 0.16695612638199664, 0.5297906087307439, 0.8273730161120461, 0.0060726430254121055, 0.5104723998635018, 0.8475138943843448, 0.2870639613110826, 0.3698299880537549, 0.3034698330212332, 0.48285957216557696, 0.497008303352211, 0.2885146313307523, 0.11642995500119468, 0.35534406929470064, 0.3613644394240805, 0.4632828718628561, 0.004301638951655695, 0.4918839862792165, 0.33925040415829244, 0.738558387172955, 0.5899226454686897, 0.30217576084220055, 0.44914173305498006, 0.3525081256972452, 0.797161135874452, 0.8879916932958913, 0.3727402302967854, 0.5335849119752102, 0.3940231944446062, 0.21276519686835416, 0.5440491444173051, 0.8408586114194857, 0.041676828065684735, 0.027161600226581872, 0.7567795542045017, 0.9841775696597946, 0.3261031238427491, 0.05238653845724728, 0.040277984254841304, 0.3265594345714635, 0.5047159216581079, 0.7615502926549994, 0.8294692492463533, 0.9233017588554429, 0.6012617868498656, 0.4508078197459626, 0.3975644812374577, 0.6980897035055829, 0.7046515095810572, 0.5344537383629208, 0.7830876472812844, 0.24784847798662968, 0.11373266522002523, 0.9270031240457544, 0.09592983132461053, 0.40629806714241745, 0.3728979058808638, 0.4548855071076938, 0.9180014570318161, 0.9663438392319013, 0.00404938690002099, 0.9428654291665577, 0.148027307977458, 0.18790082476709813, 0.7534728919901047, 0.15507603160624106, 0.17389902690495695, 0.20886986555435227, 0.28764548109759647, 0.06789448600631964, 0.22340333687726888, 0.4375412298566528, 0.6905998258531539, 0.8847021919636677, 0.5535242289977436, 0.7087213713330144, 0.6624120903876477, 0.5612464396908804, 0.8257823827791991, 0.7438662182447973, 0.9075148763469376, 0.8550509435361134, 0.6560315940547939, 0.47733140345258585, 0.6736228513056611, 0.1589717612610888, 0.42316867223073684, 0.8957455290819235, 0.41505583226225207, 0.4440561298654936, 0.9414382226249657, 0.9116917034920312, 0.5535625756450065, 0.48887917490179666, 0.9463314745251211, 0.9548416788028111, 0.8120386900212029, 0.2121786131908625, 0.06556076342437456, 0.7151091754750506, 0.5844422751824913, 0.1255598786763693, 0.4642724749304997, 0.24039724747303493, 0.20307798564223734, 0.18338725498572117, 0.21532219619592108, 0.7465319165600662, 0.21595221626252936, 0.672233714916871, 0.53553920008479, 0.46785488800192276, 0.9821665060464779, 0.16551034595542147, 0.4839901337998882, 0.37703600240756474, 0.0777903497618968, 0.8108045460774079, 0.3596504735751226, 0.1050502741495416, 0.9113061513910726, 0.3063023477153245, 0.09587499169477609, 0.11094226997203305, 0.1912253539774149, 0.913283616067968, 0.8350252519905724, 0.32708030201494975, 0.44191583010251745, 0.7423665172661895, 0.7783747756765012, 0.5042259604039134, 0.29855196422286356, 0.5615422180147053, 0.322306304570816, 0.5663086834722267, 0.5105792825581167, 0.9756817880895843, 0.5293177590460877, 0.49552939353448133, 0.09812724277681084, 0.41200786888139795, 0.9845803719394804, 0.31252205689771495, 0.5102143678225968, 0.9530384089376034, 0.6393512155861307, 0.3567413792217776, 0.6677173372554636, 0.950592026193661, 0.5639902319683388, 0.20905505844158856]
source_r = [0.0007674937192873485, 0.0013638606149484324, 0.0011277307410155635, 0.0012772377756891376, 0.0006690295406902088, 0.0011920230357121012, 0.001034202336419522, 0.0016333584085485974, 0.0003443514648442026, 0.0022020317882084834, 0.0011847957797555151, 0.0021698897609625117, 0.001764696520039134, 0.00042435680852703073, 0.00046227592222403987, 0.0013216614670164058, 0.00038546741214430497, 4.8690650358861935e-5, 0.0016986838249442025, 0.0012973130196446735, 0.0010203004307697166, 0.0006347474218166252, 0.0014475493291665744, 0.0006587918299457108, 0.0012860684052717665, 0.0008491340274344273, 0.0021372009706208026, 0.0013663796485855369, 0.0015258504283946544, 0.0019180341905194486, 0.001550090036653405, 0.0012594238285604756, 0.000893276879588255, 0.0022500552847522686, 0.0019799114345580688, 0.000292851594807744, 0.0018461975838367601, 0.0018934789968359754, 0.0003736231646302596, 0.00217639450315617, 0.001593017981032826, 0.001376947584141401, 0.0003666915130654253, 0.001484267974243869, 0.0022626746147103804, 0.00021355252657894914, 0.0017112384672035791, 0.0022867835507502697, 0.0001923729462042647, 0.002253843591247644, 0.001100035367177923, 0.0009022895803541086, 0.0011769986994552926, 0.0010495007372875692, 0.0007126721095449965, 0.0007045704109674125, 0.0015231991679731877, 0.0020174981910042215, 0.0003416258378287089, 0.001946653267781458, 0.0014564912319490106, 0.0004809483113936027, 0.0012827390471136714, 0.0012263894416862714, 0.0007165584698091195, 0.00033219220728914915, 0.0003537433967794937, 0.0011383199589536153, 0.0012227039549509125, 0.0008657664337296626, 0.0012972977880418152, 0.0001949809387643902, 0.0016156818034668977, 0.0018184685838368263, 0.0011978730850493802, 0.001532781339258498, 0.0022712230272809958, 0.0020710054879590936, 0.0009118881516886594, 0.0019193903924034673, 0.0003121007184736298, 0.000295486054384249, 0.001900368670577683, 0.0019987097809992414, 0.0002555598622285485, 0.0018703447134906692, 0.00042865043196277803, 0.0015423902254423651, 0.0006949838255121313, 0.0009513888312720695, 0.001178672968128488, 9.007400136104599e-5, 0.0021476754060739344, 0.000992138485274353, 5.297898288197529e-5, 0.002094743507806118, 0.001900263944367673, 0.001309783075189727, 0.002135169738609312, 0.002000430620352258, 0.001272969488686509, 0.0018476441368163845, 0.00020939910627586875, 0.00034031453942553883, 0.001171931897716737, 0.00045767181034907386, 0.0008677363310016233, 0.001179113397759445, 0.000285480083141687, 0.002055383831038018, 0.0007626485792525848, 0.0009124714166152235, 0.0010699725462308663, 0.0009268215451676889, 0.0005985828456034246, 0.001846767848042517, 0.0013796545854914072, 0.00012556803806842572, 0.0013943403999650266, 0.0021734112195093288, 0.0009255247543298686, 0.0013953583547480723, 0.0017017234495743582, 0.001217069377258955, 0.0007286004345395916, 4.874518902231497e-5, 0.0021221657351046027, 0.0005905519418085644, 0.0010895967142578009, 0.0017556111951400185, 0.0002336431648307724, 0.0007494841332332367, 0.00028055220598136173, 0.0022709888158273144, 0.0008196643600479264, 0.0010852336185331367, 0.0010018873885268892, 0.00205973427926525, 0.001594918199866471, 0.0014026077830096104, 0.001945917272934646, 0.00013821110922085364, 0.0016671661137420677, 0.0005767405801485137, 0.0012915996578524423, 0.0003474496353299294, 0.0011550913768618573, 0.0008654651948431648, 0.0013056702679461888, 0.0011165619614240275, 0.0017904818855894932, 0.0018052583542879548, 0.0002779392476623485, 0.001834885581753558, 0.0022191619022845954, 0.0001834543778860861, 0.0003277205823227557, 0.0018753335619945953, 0.002173961454677253, 0.00027870439657417645, 0.0002409751611585922]
target_x = SVector{3, Float64}[[0.019762653168744815, 0.49322262671840167, 0.6146823086688604], [0.013758653746782201, 0.40569508439612867, 0.5930401616484947], [0.09846654924183396, 0.48757476178236525, 0.5968433633757134], [0.06880678282061747, 0.4648189086280431, 0.5917074878129004], [0.012965025161086774, 0.412654901348518, 0.5758140421510086], [0.06914744243082616, 0.4094436515549177, 0.5320137434185968], [0.057675606114208855, 0.3975465836612594, 0.5313945941758802], [0.0730910491356278, 0.49745104222781056, 0.582914170611028], [0.04841112322118302, 0.49567710750029115, 0.5416529800005071], [0.08450166856705466, 0.47010652228760696, 0.5108117520758293], [0.10821733522041665, 0.384225743650656, 0.5738591403174563], [0.07748023473079735, 0.3777628118245435, 0.6133916186943874], [0.01612927767805039, 0.3859527546127032, 0.5674168453540513], [0.017719716182160394, 0.42917590384621374, 0.5658851158951549]]
target_m = [0.27874829747271446, 0.43743991460614096, 0.2566866928547955, 0.48252663324779643, 0.6221671114615698, 0.5430814129488558, 0.8877027558053576, 0.7774262481584308, 0.6332357692902855, 0.9955862319154513, 0.1256587632671382, 0.7848813659481927, 0.822377340306151, 0.09254940721538629]
target_r = [6.549170837058189e-5, 6.608987911711818e-5, 0.0020190664109802354, 0.0016868290625584475, 0.0015091007174213265, 0.0022612959393766424, 0.0008447665527771532, 0.0011292689009021618, 0.0010340180883555965, 0.0005765042116905871, 0.001564195080894378, 0.002174703500276763, 0.0015036992227844322, 0.002084025352248154]

source_bodies_matrix = zeros(5,length(source_x))
for i in 1:length(source_x)
    source_bodies_matrix[1:3,i] .= source_x[i]
    source_bodies_matrix[4,i] = source_r[i]
    source_bodies_matrix[5,i] = source_m[i]
end

source_system = Gravitational(source_bodies_matrix)

target_bodies_matrix = zeros(5,length(target_x))
for i in 1:length(target_x)
    target_bodies_matrix[1:3,i] .= target_x[i]
    target_bodies_matrix[4,i] = target_r[i]
    target_bodies_matrix[5,i] = target_m[i]
end

target_system = Gravitational(target_bodies_matrix)

# build branches
expansion_order = 15
source_branch = Branch(1:length(source_x), 0, 0:-1, 0, 1, source_center, source_center, source_radius, source_radius, source_box, source_box, expansion_order)
target_branch = Branch(1:length(target_x), 0, 0:-1, 0, 1, target_center, target_center, target_radius, target_radius, target_box, target_box, expansion_order)

# construct multipole expansion
body_to_multipole!(source_branch, source_system, source_branch.harmonics, expansion_order)

# evaluate multipole expansion
lamb_helmholtz = Val(false)
derivatives_switch = DerivativesSwitch(true, true, false, target_system)
FastMultipole.evaluate_multipole!(target_system, target_branch, source_branch, expansion_order, lamb_helmholtz, derivatives_switch)
multipole_potential = target_system.potential[1,:]

# perform M2L
ε = nothing
FastMultipole.multipole_to_local!(target_branch, source_branch, expansion_order, lamb_helmholtz, ε)
target_system.potential .= 0.0
FastMultipole.evaluate_local!(target_system, target_branch, expansion_order, lamb_helmholtz, derivatives_switch)
m2l_potential = target_system.potential[1,:]

# direct interaction
target_system.potential .= 0.0
direct!(target_system, source_system)
direct_potential = target_system.potential[1,:]

# get errors
error_mp = abs.(direct_potential - multipole_potential)
error_m2l = abs.(direct_potential - m2l_potential)

@show findmax(error_mp) findmax(error_m2l)

