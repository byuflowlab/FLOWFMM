using Test
using StaticArrays

include("containers.jl")
include("harmonics.jl")
include("rotate.jl")
include("bodytomultipole.jl")
include("translate.jl")
include("tree.jl")
include("evaluate_expansions.jl")
include("derivativesswitch.jl")
include("../test/gravitational_noimport.jl")

@testset "evaluate local expansion" begin

expansion_order = 10

local_weights_test = ComplexF64[0.12778297701518376 + 4.529876741832122e-19im, 0.019885650678973195 + 0.01107124020670927im, 0.00510980317232747 + 3.2526065174565133e-19im, -0.019885650678973195 + 0.011071240206709273im, 0.0064061759144352455 + 0.010337471569752702im, 0.0023855703622443353 + 0.0013281548055632461im, -0.0036451747846196194 + 1.3552527156068805e-20im, -0.0023855703622443353 + 0.0013281548055632461im, 0.006406175914435242 - 0.010337471569752699im, 0.0005064190022021772 + 0.010818798690701376im, 0.0012808551957074808 + 0.002066881139248646im, -0.0015110027312699105 - 0.0008412434906155766im, -0.0014099237691522458 - 3.078435367677348e-20im, 0.0015110027312699103 - 0.000841243490615576im, 0.0012808551957074834 - 0.002066881139248649im, -0.0005064190022021772 + 0.01081879869070138im, -0.006009793726612699 + 0.012092524384091887im, 0.0001417552658790099 + 0.0030283652182560737im, -0.0007088462398745658 - 0.0011438458681310513im, -0.0010589187153643683 - 0.0005895478929899509im, 0.0006985665385679235 - 1.6246158102786485e-19im, 0.0010589187153643683 - 0.0005895478929899511im, -0.0007088462398745665 + 0.001143845868131052im, -0.00014175526587901024 + 0.003028365218256073im, -0.006009793726612695 - 0.012092524384091866im, -0.017846595532800602 + 0.012250353278672752im, -0.002162884088792063 + 0.004352017677578853im, -6.711262856316067e-5 - 0.0014337495358817235im, -0.0007672990921280057 - 0.001238169644439577im, 0.00037417962143503 + 0.00020832270127265864im, 0.0010031456973652096 + 1.1641388389310976e-19im, -0.00037417962143503075 + 0.00020832270127265875im, -0.0007672990921280062 + 0.0012381696444395776im, 6.711262856316106e-5 - 0.0014337495358817233im, -0.002162884088792063 - 0.004352017677578859im, 0.017846595532800612 + 0.012250353278672748im, -0.042225463605343794 + 0.003961758529385453im, -0.007850173158406528 + 0.005388556820064021im, 0.0008510166456805201 - 0.001712361533117437im, -0.00010510118334571114 - 0.0022453118014719325im, 0.00015853373605836303 + 0.0002558215695988765im, 0.0010114739345698297 + 0.0005631332399612264im, -0.00014071293037591607 - 9.550575653748973e-21im, -0.0010114739345698288 + 0.0005631332399612264im, 0.00015853373605836257 - 0.00025582156959887614im, 0.00010510118334571061 - 0.0022453118014719325im, 0.0008510166456805199 + 0.0017123615331174377im, 0.00785017315840652 + 0.005388556820064014im, -0.04222546360534374 - 0.003961758529385418im, -0.0898871776608148 - 0.03954501185622584im, -0.021950729024970004 + 0.002059503335441688im, 0.0024609315428810066 - 0.001689245509397466im, 0.0018838924974092155 - 0.0037906485449506547im, 5.747049395530121e-6 + 0.00012277601925042277im, 0.0009006227210246704 + 0.0014533103533101127im, 8.939703291639945e-5 + 4.977136851668339e-5im, -0.0012765668446022285 - 3.0322332914984265e-21im, -8.939703291640068e-5 + 4.9771368516682795e-5im, 0.00090062272102467 - 0.0014533103533101114im, -5.747049395528063e-6 + 0.0001227760192504233im, 0.0018838924974092148 + 0.0037906485449506486im, -0.002460931542881007 - 0.0016892455093974695im, -0.021950729024970004 - 0.002059503335441686im, 0.08988717766081487 - 0.039545011856225824im, -0.15843104206588102 - 0.20912889072046756im, -0.05391631110482998 - 0.02371997082262677im, 0.005125742654887659 - 0.00048091743305941914im, 0.007754396968857491 - 0.005322813591027322im, 0.00019415961489653826 - 0.0003906755422485134im, 0.00014354055241060798 + 0.003066504938691552im, 0.0003024832875984886 + 0.00048810905505965093im, -0.0015642560093754251 - 0.0008708919964507312im, -0.0005359499879630815 - 3.595940057662025e-19im, 0.0015642560093754268 - 0.0008708919964507314im, 0.0003024832875984912 - 0.0004881090550596528im, -0.0001435405524106079 + 0.003066504938691553im, 0.00019415961489653837 + 0.0003906755422485172im, -0.007754396968857492 - 0.005322813591027318im, 0.005125742654887643 + 0.00048091743305941036im, 0.053916311104829986 - 0.02371997082262679im, -0.15843104206588127 + 0.20912889072046767im, -0.11111181626367748 - 0.7866131166651296im, -0.10770115350524719 - 0.14216547272568164im, 0.008278040628995856 + 0.0036418443551435855im, 0.023965741986170058 - 0.0022485595589336192im, 0.0020731640436027305 - 0.0014230718319763903im, -0.0028813446483857623 + 0.005797658260935966im, 8.704546346131179e-5 + 0.001859582317510436im, -0.0015950835889545984 - 0.002573942930823183im, -0.0012510567024948025 - 0.0006965198006367075im, 0.0023581970021940317 + 3.0687254736751804e-19im, 0.0012510567024948019 - 0.0006965198006367068im, -0.001595083588954596 + 0.0025739429308231803im, -8.70454634613075e-5 + 0.0018595823175104364im, -0.002881344648385754 - 0.005797658260935955im, -0.002073164043602728 - 0.0014230718319764041im, 0.02396574198617004 + 0.0022485595589336145im, -0.008278040628995845 + 0.0036418443551436874im, -0.10770115350524703 + 0.14216547272568159im, 0.11111181626367828 - 0.7866131166651301im, 0.9663711734836324 - 2.508759177188856im, -0.08441990368301502 - 0.5976486719026123im, 0.007922361746069495 + 0.010457501159777857im, 0.06378311778978472 + 0.028060780289836783im, 0.010522228941126748 - 0.0009872353870384969im, -0.012895443750939348 + 0.008851757750809815im, -0.0026097270576833707 + 0.005251126044978767im, -0.0002782602251141857 - 0.005944565639853102im, -0.001988047464755652 - 0.003208058151555278im, 0.003219591093161612 + 0.001792491815832389im, 0.003238333965118483 + 1.0935200630559608e-18im, -0.003219591093161612 + 0.001792491815832389im, -0.0019880474647556556 + 0.003208058151555279im, 0.00027826022511419216 - 0.005944565639853118im, -0.002609727057683363 - 0.005251126044978756im, 0.012895443750939376 + 0.00885175775080986im, 0.010522228941126768 + 0.0009872353870385342im, -0.06378311778978484 + 0.028060780289836707im, 0.007922361746068505 - 0.010457501159777267im, 0.08441990368301505 - 0.5976486719026121im, 0.9663711734836303 + 2.508759177188862im]

branch = Branch(2:2, 0, 1:0, 0, 1, SVector{3}([2.5, -4.3999999999999995, 0.8]), 0.0, expansion_order)
i_compressed, i = 1, 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            branch.local_expansion[1,1,i_compressed] = real(local_weights_test[i])
            branch.local_expansion[2,1,i_compressed] = imag(local_weights_test[i])
            i_compressed += 1
        end
        i += 1
    end
end

x_target = SVector{3}(2.3,-4.1,0.4)
Δx = x_target - branch.center
harmonics = initialize_harmonics(expansion_order)
derivatives_switch = DerivativesSwitch(true,false,false,false)
u, velocity, gradient = evaluate_local(Δx, harmonics, branch.local_expansion, derivatives_switch, Val(expansion_order))

u_test = 0.13862908274321128

@test isapprox(u, u_test; atol=1e-11)

end

